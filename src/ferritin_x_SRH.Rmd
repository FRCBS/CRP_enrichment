---
title: "Does Ferritin Affect Self-Reported Health?"
author: "Esa Turkulainen"
date: "5/10/2022"
output: md_document
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = "~/CRP_enrichment") # set working directory
source("~/CRP_enrichment/src/funcs.R") # load our helper functions
library(tidyverse)
### For prettier plots
library(ggridges)
library(viridis)
### for bootstrapping
library(boot)

boot_n <- 1000 # number of bootstrap samples
```

```{r create_datasets, echo = FALSE}
# Load data on individual donations
load("./data/r02.fd.bd.all.rdata") # outputs an object called "output" into the environment
donations <- output

# We only want to look at first donation event values from each donor
donors <- donations %>%
    group_by(donor) %>%
    filter(date == min(date)) %>%
    ungroup()

# Load FinDonor demographic data
load("./data/r02ds.donorData.rdata") # outputs an object called "output" into the environment
findonor <- output

# Combine the FinDonor datasets
FinDonor <- left_join(donors, findonor, by = "donor")

# Load THL data
# Sofie: thldalta.rdata contains all five THL cohorts, extract FINRISK97 and Health2000 from the others
load("./data/thldata.rdata")
FinRisk97 <- thldata$fr1997
Health2k <- thldata$h2000

# Remove leftovers
rm(output)
rm(thldata)

## Rename useful stuff
# Ferritin, Self-Reported Health
FinDonor <- rename(FinDonor, SRH = QR17, Menstruation = QR79, Age_float = Age, Age = age)
FinRisk97 <- rename(FinRisk97, Ferritin = FERRITIN, SRH = Q40, Gender = SUKUP, Menstruation = K129, Age = IKA)
Health2k <- rename(Health2k, Ferritin = FERRITIINI, SRH = BA01, Gender = SP2, Menstruation = BD03, Age = IKA2, Menopause = MENOP)

# Make "useful stuff" conform with each other
FinDonor <- FinDonor %>% 
    mutate(SRH = case_when(SRH == "Excellent" ~ 1,
                           SRH == "Very_good" ~ 2,
                           SRH == "Good" ~ 3,
                           SRH == "Satisfactory" ~ 4,
                           SRH == "Poor" ~ 5),
           Group = case_when(Gender == "Men" ~ "Men",
                             Gender == "Women" & (Menstruation == "regular_period" | Menstruation == "irregular_period") ~ "Women|Pre",
                             Gender == "Women" & Menstruation == "no_period" ~ "Women|Post",
                             TRUE ~ "NA")) # Equates to "else"

FinRisk97 <- FinRisk97 %>%
    mutate(Gender = case_when(Gender == 1 ~ "Men",
                              Gender == 2 ~ "Women",
                              TRUE ~ "NA"),
           Group = case_when(Gender == "Men" ~ "Men",
                             Gender == "Women" & (Menstruation == 1 | Menstruation == 2) ~ "Women|Pre",
                             Gender == "Women" & Menstruation == 3 ~ "Women|Post",
                             TRUE ~ "NA"))

Health2k <- Health2k %>%
    mutate(Gender = case_when(Gender == 1 ~ "Men",
                              Gender == 2 ~ "Women",
                              TRUE ~ "NA"),
           Group = case_when(Gender == "Men" ~ "Men",
                             Gender == "Women" & (Menstruation == 1 | Menstruation == 2) ~ "Women|Pre",
                             Gender == "Women" & (Menstruation == 3 | Age >= 55) ~ "Women|Post",
                             TRUE ~ "NA"))

# Create useful mastersets
fer_srh <- bind_rows(FinDonor = FinDonor[, c("Ferritin", "SRH", "Group")], 
                     FinRisk97 = FinRisk97[, c("Ferritin", "SRH", "Group")], 
                     Health2k = Health2k[, c("Ferritin", "SRH", "Group")], .id = "Cohort") %>% 
    mutate(Group = ordered(Group, levels = c("Women|Pre", "Women|Post", "Men")),
           Cohort = ordered(Cohort, levels = c("FinDonor", "FinRisk97", "Health2k")),
           SRH = ordered(SRH, levels = 1:5)) %>%
    filter(Group != "NA") %>%
    drop_na()

fer_srh_crp <- bind_rows(FinDonor = FinDonor[, c("Ferritin", "SRH", "Group", "CRP")], 
                     FinRisk97 = FinRisk97[, c("Ferritin", "SRH", "Group", "CRP")], 
                     Health2k = Health2k[, c("Ferritin", "SRH", "Group", "CRP")], .id = "Cohort") %>% 
    mutate(Group = ordered(Group, levels = c("Women|Pre", "Women|Post", "Men")),
           Cohort = ordered(Cohort, levels = c("FinDonor", "FinRisk97", "Health2k")),
           SRH = ordered(SRH, levels = 1:5)) %>%
    filter(Group != "NA" | CRP != NA) %>%
    drop_na()
```

### Cohort Check
Let's first check what kind of measurements these cohorts offer for these two variables. We do this, because we want to know if the variables differ significantly between cohorts. If they do, we need to study them separately.

```{r cohort_ferritin_SRH_plots, echo = FALSE, message = FALSE, fig.align = "center", out.width = "70%"}
plt1 <- ggplot(data = fer_srh, aes(x = Ferritin, y = Cohort, fill = Cohort)) +
    geom_density_ridges() +
    xlab(expression("Ferritin ("*mu* "g/l)")) +
    scale_x_log10(breaks = c(0, 15, 30, 50, 100)) +
    scale_fill_brewer(palette = "Spectral") +
    theme_minimal() + 
    theme(legend.position = "none",
          legend.title = element_blank(),
          legend.background = element_blank()) + 
    labs(title = "Ferritin per Cohort")

plt2 <- ggplot(data = fer_srh, aes(x = as.numeric(SRH), y = Cohort, fill = Cohort)) +
    geom_density_ridges(stat = "binline", bins = 5) +
    xlab("Self-Reported Health from Good (1) to Bad (5)") +
    scale_fill_brewer(palette = "Spectral") +
    theme_minimal() + 
    theme(legend.position = "none",
          legend.title = element_blank(),
          legend.background = element_blank()) + 
    labs(title = "Self-Reported Health per Cohort") 

multiplot(plt1, plt2, cols = 1)
```

It would seem reasonable to study these cohorts separately. The FinDonor cohort differs from Health2k and FinRisk97 significantly in terms of ferritin measurements, and the Health2k differs significantly from the others with respect to self-reported health.

### Boxplots 

To study how and if ferritin measurements correlate with self-reported health, we first explore some box plots. We wish to do this for each cohort, and within them, to the following groups: men, menstruating women, non-menstruating women. This is because menstruation causes regular loss of ferritin from the bloodstream.

```{r boxplots, echo = FALSE, message = FALSE, fig.align = "center", fig.height = 15, fig.width = 5}
plt1 <- ggplot(data = fer_srh %>% filter(Cohort == "FinDonor"), aes(x = SRH, y = Ferritin, color = Group)) + 
    geom_hline(yintercept = 15, color = "dark red", size = .2, linetype = 2) +
    geom_boxplot(outlier.alpha = 0, alpha = 0, size = 0.3, width = 0.5) +
    geom_jitter(alpha = 0.3, shape = 1, size = 0.15, position = position_jitterdodge(jitter.height = 0, jitter.width = 0.5 )) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    facet_grid(Group ~ .) +
    xlab("How is your health in general?") +
    ylab(expression("Ferritin ("*mu* "g/l)")) +
    scale_y_log10(breaks = c(5, 15, 25, 50, 100)) +
    theme_bw() +
    theme(legend.position = "none",
          legend.title = element_blank(),
          legend.background = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour = NA),
          strip.background = element_blank(),
          axis.line = element_line(colour = "black"),
          axis.title.x = element_text(size = 10),
          axis.title.y = element_text(size = 10),
          axis.text = element_text(size = 8)) +
    labs(title = "FinDonor",
         subtitle = "NB! No donor rated their health as 'Very Bad'.")

plt2 <- ggplot(data = fer_srh %>% filter(Cohort == "FinRisk97"), aes(x = SRH, y = Ferritin, color = Group)) + 
    geom_hline(yintercept = 15, color = "dark red", size = .2, linetype = 2) +
    geom_boxplot(outlier.alpha = 0, alpha = 0, size = 0.3, width = 0.5) +
    geom_jitter(alpha = 0.3, shape = 1, size = 0.15, position = position_jitterdodge(jitter.height = 0, jitter.width = 0.5 )) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    facet_grid(Group ~ .) +
    xlab("How is your health in general?") +
    ylab(expression("Ferritin ("*mu* "g/l)")) +
    scale_y_log10(breaks = c(5, 15, 25, 50, 100)) +
    theme_bw() +
    theme(legend.position = "none",
          legend.title = element_blank(),
          legend.background = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour = NA),
          strip.background = element_blank(),
          axis.line = element_line(colour = "black"),
          axis.title.x = element_text(size = 10),
          axis.title.y = element_text(size = 10),
          axis.text = element_text(size = 8)) +
    labs(title = "FinRisk 1997")

plt3 <- ggplot(data = fer_srh %>% filter(Cohort == "Health2k"), aes(x = SRH, y = Ferritin, color = Group)) + 
    geom_hline(yintercept = 15, color = "dark red", size = .2, linetype = 2) +
    geom_boxplot(outlier.alpha = 0, alpha = 0, size = 0.3, width = 0.5) +
    geom_jitter(alpha = 0.3, shape = 1, size = 0.15, position = position_jitterdodge(jitter.height = 0, jitter.width = 0.5 )) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    facet_grid(Group ~ .) +
    xlab("How is your health in general?") +
    ylab(expression("Ferritin ("*mu* "g/l)")) +
    scale_y_log10(breaks = c(5, 15, 25, 50, 100)) +
    theme_bw() +
    theme(legend.position = "none",
          legend.title = element_blank(),
          legend.background = element_blank(), 
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.border = element_rect(colour = NA),
          strip.background = element_blank(),
          axis.line = element_line(colour = "black"),
          axis.title.x = element_text(size = 10),
          axis.title.y = element_text(size = 10),
          axis.text = element_text(size = 8)) +
    labs(title = "Health 2000")

multiplot(plt1, plt2, plt3, cols = 1)
```

### Line plots

To examine correlation via a line plot, we'll take the mean of self-reported health for subpopulations limited by different ferritin values and draw a line through them. We'll want to do this again separately for each cohort and cohort subgroup. Also, we'll bootstrap our estimates so we get confidence intervals. For exploration purposes we'll use a fairly low number of bootstrap samples (such as 100), but for publication purposes we should aim somewhere around 10k samples.

```{r boot_mean, echo = FALSE}
ferritin_values <- seq(5, 50, 1)
iterations <- length(ferritin_values)

if (!file.exists(paste0("./data/findonor_fer_x_SRH_means_", boot_n, ".rds"))) { # run bootstrap only if needed
    ## Preallocate
    # Men
    means_men <- 1:iterations
    upper_men <- 1:iterations
    lower_men <- 1:iterations
    # Women|Pre
    means_women_pre <- 1:iterations
    upper_women_pre <- 1:iterations
    lower_women_pre <- 1:iterations
    # Women|Post
    means_women_post <- 1:iterations
    upper_women_post <- 1:iterations
    lower_women_post <- 1:iterations

    for (i in 1:iterations) {
    
    #############
    #### FinDonor
    #############
    
    ## Compute
    # Men
    boot_obj_men <- boot(fer_srh %>% filter(Cohort == "FinDonor" & Group == "Men"), statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_men <- boot.ci(boot_obj_men, type = "norm")
    # Women|Pre
    boot_obj_women_pre <- boot(fer_srh %>% filter(Cohort == "FinDonor" & Group == "Women|Pre"), statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_women_pre <- boot.ci(boot_obj_women_pre, type = "norm")
    # Women|Post
    boot_obj_women_post <- boot(fer_srh %>% filter(Cohort == "FinDonor" & Group == "Women|Post"), statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_women_post <- boot.ci(boot_obj_women_post, type = "norm")
    
    ## Store
    # Men
    means_men[i] <- boot_obj_men$t0
    upper_men[i] <- ci_obj_men$normal[3]
    lower_men[i] <- ci_obj_men$normal[2]
    # Women|Pre
    means_women_pre[i] <- boot_obj_women_pre$t0
    upper_women_pre[i] <- ci_obj_women_pre$normal[3]
    lower_women_pre[i] <- ci_obj_women_pre$normal[2]
    # Women|Post
    means_women_post[i] <- boot_obj_women_post$t0
    upper_women_post[i] <- ci_obj_women_post$normal[3]
    lower_women_post[i] <- ci_obj_women_post$normal[2]
    
    # Combine
    means_findonor <- data.frame(Ferritin = rep(ferritin_values, 3),
                                 means = c(means_men, means_women_pre, means_women_post),
                                 upper = c(upper_men, upper_women_pre, upper_women_post),
                                 lower = c(lower_men, lower_women_pre, lower_women_post),
                                 Gender = c(rep("Men", iterations), rep("Women|Pre", iterations), rep("Women|Post", iterations)))
}
    
    # Save
    saveRDS(means_findonor, paste0("./data/findonor_fer_x_SRH_means_", boot_n, ".rds"))
} else {means_findonor <- readRDS(paste0("./data/findonor_fer_x_SRH_means_", boot_n, ".rds"))}

if (!file.exists(paste0("./data/finrisk_fer_x_SRH_means_", boot_n, ".rds"))) { # run bootstrap only if needed
    ## Preallocate
    # Men
    means_men <- 1:iterations
    upper_men <- 1:iterations
    lower_men <- 1:iterations
    # Women|Pre
    means_women_pre <- 1:iterations
    upper_women_pre <- 1:iterations
    lower_women_pre <- 1:iterations
    # Women|Post
    means_women_post <- 1:iterations
    upper_women_post <- 1:iterations
    lower_women_post <- 1:iterations
    
    for (i in 1:iterations) {
        
        #############
        #### FinRisk97
        #############
        
        ## Compute
        # Men
        boot_obj_men <- boot(fer_srh %>% filter(Cohort == "FinRisk97" & Group == "Men"), statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
        ci_obj_men <- boot.ci(boot_obj_men, type = "norm")
        # Women|Pre
        boot_obj_women_pre <- boot(fer_srh %>% filter(Cohort == "FinRisk97" & Group == "Women|Pre"), statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
        ci_obj_women_pre <- boot.ci(boot_obj_women_pre, type = "norm")
        # Women|Post
        boot_obj_women_post <- boot(fer_srh %>% filter(Cohort == "FinRisk97" & Group == "Women|Post"), statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
        ci_obj_women_post <- boot.ci(boot_obj_women_post, type = "norm")
        
        ## Store
        # Men
        means_men[i] <- boot_obj_men$t0
        upper_men[i] <- ci_obj_men$normal[3]
        lower_men[i] <- ci_obj_men$normal[2]
        # Women|Pre
        means_women_pre[i] <- boot_obj_women_pre$t0
        upper_women_pre[i] <- ci_obj_women_pre$normal[3]
        lower_women_pre[i] <- ci_obj_women_pre$normal[2]
        # Women|Post
        means_women_post[i] <- boot_obj_women_post$t0
        upper_women_post[i] <- ci_obj_women_post$normal[3]
        lower_women_post[i] <- ci_obj_women_post$normal[2]
        
        # Combine
        means_finrisk <- data.frame(Ferritin = rep(ferritin_values, 3),
                                     means = c(means_men, means_women_pre, means_women_post),
                                     upper = c(upper_men, upper_women_pre, upper_women_post),
                                     lower = c(lower_men, lower_women_pre, lower_women_post),
                                     Gender = c(rep("Men", iterations), rep("Women|Pre", iterations), rep("Women|Post", iterations)))
    
    }
    
    # Save
    saveRDS(means_finrisk, paste0("./data/finrisk_fer_x_SRH_means_", boot_n, ".rds"))
} else {means_finrisk <- readRDS(paste0("./data/finrisk_fer_x_SRH_means_", boot_n, ".rds"))}

if (!file.exists(paste0("./data/health2k_fer_x_SRH_means_", boot_n, ".rds"))) { # run bootstrap only if needed
    ## Preallocate
    # Men
    means_men <- 1:iterations
    upper_men <- 1:iterations
    lower_men <- 1:iterations
    # Women|Pre
    means_women_pre <- 1:iterations
    upper_women_pre <- 1:iterations
    lower_women_pre <- 1:iterations
    # Women|Post
    means_women_post <- 1:iterations
    upper_women_post <- 1:iterations
    lower_women_post <- 1:iterations

    for (i in 1:iterations) {
    
    #############
    #### Health2000
    #############
    
    ## Compute
    # Men
    boot_obj_men <- boot(fer_srh %>% filter(Cohort == "Health2k" & Group == "Men"), statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_men <- boot.ci(boot_obj_men, type = "norm")
    # Women|Pre
    boot_obj_women_pre <- boot(fer_srh %>% filter(Cohort == "Health2k" & Group == "Women|Pre"), statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_women_pre <- boot.ci(boot_obj_women_pre, type = "norm")
    # Women|Post
    boot_obj_women_post <- boot(fer_srh %>% filter(Cohort == "Health2k" & Group == "Women|Post"), statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_women_post <- boot.ci(boot_obj_women_post, type = "norm")
    
    ## Store
    # Men
    means_men[i] <- boot_obj_men$t0
    upper_men[i] <- ci_obj_men$normal[3]
    lower_men[i] <- ci_obj_men$normal[2]
    # Women|Pre
    means_women_pre[i] <- boot_obj_women_pre$t0
    upper_women_pre[i] <- ci_obj_women_pre$normal[3]
    lower_women_pre[i] <- ci_obj_women_pre$normal[2]
    # Women|Post
    means_women_post[i] <- boot_obj_women_post$t0
    upper_women_post[i] <- ci_obj_women_post$normal[3]
    lower_women_post[i] <- ci_obj_women_post$normal[2]
    
    # Combine
    means_health2k <- data.frame(Ferritin = rep(ferritin_values, 3),
                                 means = c(means_men, means_women_pre, means_women_post),
                                 upper = c(upper_men, upper_women_pre, upper_women_post),
                                 lower = c(lower_men, lower_women_pre, lower_women_post),
                                 Gender = c(rep("Men", iterations), rep("Women|Pre", iterations), rep("Women|Post", iterations)))    
    
    
    }
    
    # Save
    saveRDS(means_health2k, paste0("./data/health2k_fer_x_SRH_means_", boot_n, ".rds"))
} else {means_health2k <- readRDS(paste0("./data/health2k_fer_x_SRH_means_", boot_n, ".rds"))}

```


```{r correlation_lineplot, echo = FALSE, fig.align = "center", fig.height = 12, fig.width = 7}
findonor_lineplt <- ggplot(data = means_findonor, aes(x = Ferritin, y = means)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, group = Gender, fill = Gender), alpha = .2) +
    geom_line(aes(linetype = Gender, color = Gender)) +
    geom_point(shape = 4) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    scale_fill_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                      limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    theme_minimal() +
    labs(title = "Mean of self-reported health by ferritin filter level",
         subtitle = "FinDonor",
         y = "Mean of self-reported health",
         color = "Marker") + guides(fill = "none", color = "none", linetype = "none") +
    theme(axis.title.x = element_blank())

finrisk_lineplt <- ggplot(data = means_finrisk, aes(x = Ferritin, y = means)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, group = Gender, fill = Gender), alpha = .2) +
    geom_line(aes(linetype = Gender, color = Gender)) +
    geom_point(shape = 4) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    scale_fill_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                      limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    theme_minimal() +
    labs(subtitle = "FinRisk 1997",
         y = "Mean of self-reported health",
         color = "Marker") + guides(fill = "none", color = "none", linetype = "none") +
    theme(axis.title.x = element_blank())

health2k_lineplt <- ggplot(data = means_health2k, aes(x = Ferritin, y = means)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, group = Gender, fill = Gender), alpha = .2) +
    geom_line(aes(linetype = Gender, color = Gender)) +
    geom_point(shape = 4) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    scale_fill_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                      limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    theme_minimal() +
    labs(subtitle = "Health 2000",
         y = "Mean of self-reported health",
         x = expression("Ferritin ("*mu* "g/l)"),
         color = "Marker") + guides(fill = "none", linetype = "none") +
    theme(legend.position = "bottom")

multiplot(findonor_lineplt, finrisk_lineplt, health2k_lineplt, cols = 1)
```

### Control for CRP

Next we'll see what happens to this relationship, if we control for CRP, a common inflammatory marker. This time, we'll focus on cohorts and groups where any effect was measured, namely the non-menstruating women in the FinRisk97 and Health200 cohorts.

First we'll check how the CRP distributes between these two cohorts, to help us select control points.

```{r crp_distr, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 8, fig.height = 4}
ggplot(data = fer_srh_crp %>% filter(Cohort != "FinDonor"), aes(x = CRP, y = Cohort, fill = Cohort)) +
    geom_density_ridges(stat = "binline", bins = 100) +
    geom_vline(xintercept = c(0.3, 1.65, 3)) +
    xlab("CRP (mg/l)") +
    xlim(c(0.1, 5)) +
    scale_fill_brewer(palette = "Spectral") +
    theme_minimal() + 
    theme(legend.position = "none",
          legend.title = element_blank(),
          legend.background = element_blank()) + 
    labs(title = "CRP per Cohort")
```

The FinRisk 1997 and Health 2000 cohorts have largerly similar CRP distributions. We will not use the FinDonor set here at all, because it has no sensible observations under 3 mg/l, and those above are measured in integers. Eyeballing nice control points, we could probably choose 3 equidistant points between the 3 mg/l and the common high point of the histograms, 0.3 mg/l.

```{r control_CRP, echo = FALSE}
CRP_points <- c(0.3, 1.65, 3)

if (!file.exists(paste0("./data/finrisk_CRP_controlled_fer_x_SRH_means_", boot_n, ".rds"))) { # run bootstrap only if needed
    ## Preallocate
    # CRP >= 0 & CRP <= 0.6
    means_low <- 1:iterations
    upper_low <- 1:iterations
    lower_low <- 1:iterations
    # CRP >= 1.35 & CRP <= 1.95
    means_med <- 1:iterations
    upper_med <- 1:iterations
    lower_med <- 1:iterations
    # CRP >= 2.7 & CRP <= 3.3
    means_hi <- 1:iterations
    upper_hi <- 1:iterations
    lower_hi <- 1:iterations

    for (i in 1:iterations) {
    
    #############
    #### FinRisk
    #############
    
    ## Compute
    # Low
    boot_obj_low <- boot(fer_srh_crp %>% filter(Cohort == "FinRisk97" & Group == "Women|Pre")  %>% filter(CRP >= 0 & CRP <= 0.6), 
                               statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_low <- boot.ci(boot_obj_low, type = "norm")
    # Med
    boot_obj_med <- boot(fer_srh_crp %>% filter(Cohort == "FinRisk97" & Group == "Women|Pre")  %>% filter(CRP >= 1.35 & CRP <= 1.95),
                               statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_med <- boot.ci(boot_obj_med, type = "norm")
    # Hi
    boot_obj_hi <- boot(fer_srh_crp %>% filter(Cohort == "FinRisk97" & Group == "Women|Pre")  %>% filter(CRP >= 2.7 & CRP <= 3.3),
                        statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_hi <- boot.ci(boot_obj_hi, type = "norm")
    
    ## Store
    # Men
    means_low[i] <- boot_obj_low$t0
    upper_low[i] <- ci_obj_low$normal[3]
    lower_low[i] <- ci_obj_low$normal[2]
    # Women|Pre
    means_med[i] <- boot_obj_med$t0
    upper_med[i] <- ci_obj_med$normal[3]
    lower_med[i] <- ci_obj_med$normal[2]
    # Women|Post
    means_hi[i] <- boot_obj_hi$t0
    upper_hi[i] <- ci_obj_hi$normal[3]
    lower_hi[i] <- ci_obj_hi$normal[2]

    
    # Combine
    means_finrisk <- data.frame(Ferritin = rep(ferritin_values, 3),
                                 means = c(means_low, means_med, means_hi),
                                 upper = c(upper_low, upper_med, upper_hi),
                                 lower = c(lower_low, lower_med, lower_hi),
                                 Control = c(rep("0.3", iterations), rep("1.65", iterations), rep("3", iterations)))
}
    
    # Save
    saveRDS(means_finrisk, paste0("./data/finrisk_CRP_controlled_fer_x_SRH_means_", boot_n, ".rds"))
} else {means_finrisk <- readRDS(paste0("./data/finrisk_CRP_controlled_fer_x_SRH_means_", boot_n, ".rds"))}

if (!file.exists(paste0("./data/health2k_CRP_controlled_fer_x_SRH_means_", boot_n, ".rds"))) { # run bootstrap only if needed
    ## Preallocate
    # CRP >= 0 & CRP <= 0.6
    means_low <- 1:iterations
    upper_low <- 1:iterations
    lower_low <- 1:iterations
    # CRP >= 1.35 & CRP <= 1.95
    means_med <- 1:iterations
    upper_med <- 1:iterations
    lower_med <- 1:iterations
    # CRP >= 2.7 & CRP <= 3.3
    means_hi <- 1:iterations
    upper_hi <- 1:iterations
    lower_hi <- 1:iterations

    for (i in 1:iterations) {
    
    #############
    #### FinRisk
    #############
    
    ## Compute
    # Low
    boot_obj_low <- boot(fer_srh_crp %>% filter(Cohort == "Health2k" & Group == "Women|Pre")  %>% filter(CRP >= 0 & CRP <= 0.6), 
                               statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_low <- boot.ci(boot_obj_low, type = "norm")
    # Med
    boot_obj_med <- boot(fer_srh_crp %>% filter(Cohort == "Health2k" & Group == "Women|Pre")  %>% filter(CRP >= 1.35 & CRP <= 1.95),
                               statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_med <- boot.ci(boot_obj_med, type = "norm")
    # Hi
    boot_obj_hi <- boot(fer_srh_crp %>% filter(Cohort == "Health2k" & Group == "Women|Pre")  %>% filter(CRP >= 2.7 & CRP <= 3.3),
                        statistic = get_mean_boot, R = boot_n, var1 = Ferritin, var2 = SRH, var1_trld = ferritin_values[i])
    ci_obj_hi <- boot.ci(boot_obj_hi, type = "norm")
    
    ## Store
    # Men
    means_low[i] <- boot_obj_low$t0
    upper_low[i] <- ci_obj_low$normal[3]
    lower_low[i] <- ci_obj_low$normal[2]
    # Women|Pre
    means_med[i] <- boot_obj_med$t0
    upper_med[i] <- ci_obj_med$normal[3]
    lower_med[i] <- ci_obj_med$normal[2]
    # Women|Post
    means_hi[i] <- boot_obj_hi$t0
    upper_hi[i] <- ci_obj_hi$normal[3]
    lower_hi[i] <- ci_obj_hi$normal[2]

    
    # Combine
    means_health2k <- data.frame(Ferritin = rep(ferritin_values, 3),
                                 means = c(means_low, means_med, means_hi),
                                 upper = c(upper_low, upper_med, upper_hi),
                                 lower = c(lower_low, lower_med, lower_hi),
                                 Control = c(rep("0.3", iterations), rep("1.65", iterations), rep("3", iterations)))
}
    
    # Save
    saveRDS(means_health2k, paste0("./data/health2k_CRP_controlled_fer_x_SRH_means_", boot_n, ".rds"))
} else {means_health2k <- readRDS(paste0("./data/health2k_CRP_controlled_fer_x_SRH_means_", boot_n, ".rds"))}

```



```{r CRP_control_plot, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 7, fig.height = 8}
findonor_ctrlplt <- ggplot(data = means_finrisk, aes(x = Ferritin, y = means)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, group = Control, fill = Control), alpha = .5) +
    geom_line(aes(linetype = Control, color = Control)) +
    geom_point(shape = 4) +
    scale_color_brewer(palette = "Spectral") +
    scale_fill_brewer(palette = "Spectral") +
    theme_minimal() +
    labs(title = "Mean of self-reported health by ferritin filter level",
         subtitle = "FinRisk 1997",
         y = "Mean of self-reported health",
         color = "Marker") + guides(fill = "none", color = "none", linetype = "none") +
    theme(axis.title.x = element_blank()) + labs(Marker = "CRP control (+- 0.3 mg/l)")
health2k_ctrlplt <- ggplot(data = means_health2k, aes(x = Ferritin, y = means)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, group = Control, fill = Control), alpha = .5) +
    geom_line(aes(linetype = Control, color = Control)) +
    geom_point(shape = 4) +
    scale_color_brewer(palette = "Spectral") +
    scale_fill_brewer(palette = "Spectral") +
    theme_minimal() +
    labs(subtitle = "Health 2000",
         y = "Mean of self-reported health",
         color = "CRP control (+- 0.3 mg/l)") + guides(fill = "none", linetype = "none") +
    theme(axis.title.x = element_blank(),
          legend.position = "bottom")

multiplot(findonor_ctrlplt, health2k_ctrlplt, cols = 1)
```

```{r filter_donor_eligibility, echo = FALSE}

# These are both "approximates" in a sense, we don't have all the necessary variables to
# filter thoroughly, and we'll be able to do more filtering on Health2000 than FinRisk97

donor_eligible_h2k <- Health2k %>%
    filter(BMII_PAINO.x >= 50 & BMII_PAINO.x <= 200) %>% # Filter away people <50kg and >200kg
    filter(Age >= 18 & Age <= 66) %>% # Filter away too young and too old
    filter((B_Hb >= 125 & Gender == "Women") | (B_Hb >= 135 & Gender == "Men")) %>% # Filter by hemoglobin
    filter(BA08 == 0) %>% # filter out people with heart attacks
    filter(BA09 == 0) %>% # filter out people with angina
    filter(BA10 == 0) %>% # cardiac insufficiency / heart failure
    filter(!(BA26 == 1 & ATC_A10A == 1)) %>% # filter out people who are diabetic AND use insulin
    filter(SRH < 4) %>% # filter out "Bad" or "Very bad" SRH
    rename(GlycA = GP) %>% # rename for ease of use
    mutate(HbA1C = B_GHb_A1C * 10.93 - 23.50)

donor_eligible_fr <- FinRisk97 %>%
    filter(PAINO >= 50 & PAINO <= 200) %>% # Filter away people <50kg and >200kg
    filter(Age >= 18 & Age <= 66) %>% # Filter away too young and too old
    #filter((HGB >= 125 & Gender == 2) | (HGB >= 135 & Gender == 1)) %>% # DON'T filter by hemoglobin, < 500 values in data
    filter(Q15A != 2) %>% # STEMI, NSTEMI
    filter(Q16A != 2) %>% # Stroke
    # filter(Q38 != 2 & Q38 != 4) %>%  # Insulin treatment (2: just insulin, 4: insulin and a tablet)
    filter(Q17B != 2) %>% # cardiac insufficiency
    filter(Q17C != 2) %>% # angina pectoris
    filter(SRH < 4) %>% # filter out "Bad" or "Very bad" SRH
    rename(GlycA = GP) # rename for ease of use

```


```{r ratio_boot_CRP_by_subgroup, echo = FALSE}
ferritin_values <- seq(5, 50, 1)
iterations <- length(ferritin_values)
CRP_trld <- 3

if (!file.exists(paste0("./data/finrisk_ratio_CRP", boot_n, ".rds"))) { # run bootstrap only if needed
    
    ## Preallocate
    # Men
    means_men <- 1:iterations
    upper_men <- 1:iterations
    lower_men <- 1:iterations
    # Women|Pre
    means_women_pre <- 1:iterations
    upper_women_pre <- 1:iterations
    lower_women_pre <- 1:iterations
    # Women|Post
    means_women_post <- 1:iterations
    upper_women_post <- 1:iterations
    lower_women_post <- 1:iterations
    
    for (i in 1:iterations) {
        
        #############
        #### FinRisk97
        #############
        
        ## Compute
        # Men
        boot_obj_men <- boot(donor_eligible_fr %>% filter(Group == "Men"), statistic = get_ratio_boot, R = boot_n, 
                             var1 = Ferritin, var2 = CRP, var1_trld = ferritin_values[i], var2_trld = CRP_trld)
        ci_obj_men <- boot.ci(boot_obj_men, type = "norm")
        # Women|Pre
        boot_obj_women_pre <- boot(donor_eligible_fr %>% filter(Group == "Women|Pre"), statistic = get_ratio_boot, R = boot_n, 
                                   var1 = Ferritin, var2 = CRP, var1_trld = ferritin_values[i], var2_trld = CRP_trld)
        ci_obj_women_pre <- boot.ci(boot_obj_women_pre, type = "norm")
        # Women|Post
        boot_obj_women_post <- boot(donor_eligible_fr %>% filter(Group == "Women|Post"), statistic = get_ratio_boot, R = boot_n, 
                                    var1 = Ferritin, var2 = CRP, var1_trld = ferritin_values[i],var2_trld = CRP_trld)
        ci_obj_women_post <- boot.ci(boot_obj_women_post, type = "norm")
        
        ## Store
        # Men
        means_men[i] <- boot_obj_men$t0
        upper_men[i] <- ci_obj_men$normal[3]
        lower_men[i] <- ci_obj_men$normal[2]
        # Women|Pre
        means_women_pre[i] <- boot_obj_women_pre$t0
        upper_women_pre[i] <- ci_obj_women_pre$normal[3]
        lower_women_pre[i] <- ci_obj_women_pre$normal[2]
        # Women|Post
        means_women_post[i] <- boot_obj_women_post$t0
        upper_women_post[i] <- ci_obj_women_post$normal[3]
        lower_women_post[i] <- ci_obj_women_post$normal[2]
        
        # Combine
        means_finrisk <- data.frame(Ferritin = rep(ferritin_values, 3),
                                     means = c(means_men, means_women_pre, means_women_post),
                                     upper = c(upper_men, upper_women_pre, upper_women_post),
                                     lower = c(lower_men, lower_women_pre, lower_women_post),
                                     Gender = c(rep("Men", iterations), rep("Women|Pre", iterations), rep("Women|Post", iterations)))
    
    }
    
    # Save
    saveRDS(means_finrisk, paste0("./data/finrisk_ratio_CRP", boot_n, ".rds"))
} else {means_finrisk <- readRDS(paste0("./data/finrisk_ratio_CRP", boot_n, ".rds"))}

if (!file.exists(paste0("./data/health2k_ratio_CRP", boot_n, ".rds"))) { # run bootstrap only if needed
    ## Preallocate
    # Men
    means_men <- 1:iterations
    upper_men <- 1:iterations
    lower_men <- 1:iterations
    # Women|Pre
    means_women_pre <- 1:iterations
    upper_women_pre <- 1:iterations
    lower_women_pre <- 1:iterations
    # Women|Post
    means_women_post <- 1:iterations
    upper_women_post <- 1:iterations
    lower_women_post <- 1:iterations

    for (i in 1:iterations) {
    
    #############
    #### Health2000
    #############
    
    ## Compute
    # Men
    boot_obj_men <- boot(donor_eligible_h2k %>% filter(Group == "Men"), statistic = get_ratio_boot, R = boot_n, 
                         var1 = Ferritin, var2 = CRP, var1_trld = ferritin_values[i], var2_trld = CRP_trld)
    ci_obj_men <- boot.ci(boot_obj_men, type = "norm")
    # Women|Pre
    boot_obj_women_pre <- boot(donor_eligible_h2k %>% filter(Group == "Women|Pre"), statistic = get_ratio_boot, R = boot_n, 
                               var1 = Ferritin, var2 = CRP, var1_trld = ferritin_values[i], var2_trld = CRP_trld)
    ci_obj_women_pre <- boot.ci(boot_obj_women_pre, type = "norm")
    # Women|Post
    boot_obj_women_post <- boot(donor_eligible_h2k %>% filter(Group == "Women|Post"), statistic = get_ratio_boot, R = boot_n, 
                                var1 = Ferritin, var2 = CRP, var1_trld = ferritin_values[i], var2_trld = CRP_trld)
    ci_obj_women_post <- boot.ci(boot_obj_women_post, type = "norm")
    
    ## Store
    # Men
    means_men[i] <- boot_obj_men$t0
    upper_men[i] <- ci_obj_men$normal[3]
    lower_men[i] <- ci_obj_men$normal[2]
    # Women|Pre
    means_women_pre[i] <- boot_obj_women_pre$t0
    upper_women_pre[i] <- ci_obj_women_pre$normal[3]
    lower_women_pre[i] <- ci_obj_women_pre$normal[2]
    # Women|Post
    means_women_post[i] <- boot_obj_women_post$t0
    upper_women_post[i] <- ci_obj_women_post$normal[3]
    lower_women_post[i] <- ci_obj_women_post$normal[2]
    
    # Combine
    means_health2k <- data.frame(Ferritin = rep(ferritin_values, 3),
                                 means = c(means_men, means_women_pre, means_women_post),
                                 upper = c(upper_men, upper_women_pre, upper_women_post),
                                 lower = c(lower_men, lower_women_pre, lower_women_post),
                                 Gender = c(rep("Men", iterations), rep("Women|Pre", iterations), rep("Women|Post", iterations)))    
    
    
    }
    
    # Save
    saveRDS(means_health2k, paste0("./data/health2k_ratio_CRP", boot_n, ".rds"))
} else {means_health2k <- readRDS(paste0("./data/health2k_ratio_CRP", boot_n, ".rds"))}

```

```{r CRP_ratio_plot, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 7, fig.height = 8}
finrisk_ctrlplt <- ggplot(data = means_finrisk, aes(x = Ferritin, y = means)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, group = Gender, fill = Gender), alpha = .5) +
    geom_line(aes(linetype = Gender, color = Gender)) +
    geom_point(shape = 4) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    scale_fill_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                      limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    theme_minimal() +
    labs(title = "Increase in ratio of people over 3 mg/l CRP",
         subtitle = "FinRisk 1997",
         y = "Increase (%-p)",
         color = "Marker") + guides(fill = "none", color = "none", linetype = "none") +
    theme(axis.title.x = element_blank()) + labs(Marker = "Gender")
health2k_ctrlplt <- ggplot(data = means_health2k, aes(x = Ferritin, y = means)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, group = Gender, fill = Gender), alpha = .5) +
    geom_line(aes(linetype = Gender, color = Gender)) +
    geom_point(shape = 4) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    scale_fill_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                      limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    theme_minimal() +
    labs(subtitle = "Health 2000",
         y = "Increase (%-p)",
         color = "Gender") + guides(fill = "none", linetype = "none") +
    theme(axis.title.x = element_blank(),
          legend.position = "bottom")

multiplot(finrisk_ctrlplt, health2k_ctrlplt, cols = 1)
```

```{r ratio_boot_GlycA_by_subgroup, echo = FALSE}
ferritin_values <- seq(5, 50, 1)
iterations <- length(ferritin_values)

if (!file.exists(paste0("./data/finrisk_ratio_GlycA", boot_n, ".rds"))) { # run bootstrap only if needed
    
    #############
    #### FinRisk97
    #############
    
    GlycA_trld <- median(donor_eligible_fr$GlycA, na.rm = T)
    
    ## Preallocate
    # Men
    means_men <- 1:iterations
    upper_men <- 1:iterations
    lower_men <- 1:iterations
    # Women|Pre
    means_women_pre <- 1:iterations
    upper_women_pre <- 1:iterations
    lower_women_pre <- 1:iterations
    # Women|Post
    means_women_post <- 1:iterations
    upper_women_post <- 1:iterations
    lower_women_post <- 1:iterations
    
    for (i in 1:iterations) {
        
        ## Compute
        # Men
        boot_obj_men <- boot(donor_eligible_fr %>% filter(Group == "Men"), statistic = get_ratio_boot, R = boot_n, 
                             var1 = Ferritin, var2 = GlycA, var1_trld = ferritin_values[i], var2_trld = GlycA_trld)
        ci_obj_men <- boot.ci(boot_obj_men, type = "norm")
        # Women|Pre
        boot_obj_women_pre <- boot(donor_eligible_fr %>% filter(Group == "Women|Pre"), statistic = get_ratio_boot, R = boot_n, 
                                   var1 = Ferritin, var2 = GlycA, var1_trld = ferritin_values[i], var2_trld = GlycA_trld)
        ci_obj_women_pre <- boot.ci(boot_obj_women_pre, type = "norm")
        # Women|Post
        boot_obj_women_post <- boot(donor_eligible_fr %>% filter(Group == "Women|Post"), statistic = get_ratio_boot, R = boot_n, 
                                    var1 = Ferritin, var2 = GlycA, var1_trld = ferritin_values[i], var2_trld = GlycA_trld)
        ci_obj_women_post <- boot.ci(boot_obj_women_post, type = "norm")
        
        ## Store
        # Men
        means_men[i] <- boot_obj_men$t0
        upper_men[i] <- ci_obj_men$normal[3]
        lower_men[i] <- ci_obj_men$normal[2]
        # Women|Pre
        means_women_pre[i] <- boot_obj_women_pre$t0
        upper_women_pre[i] <- ci_obj_women_pre$normal[3]
        lower_women_pre[i] <- ci_obj_women_pre$normal[2]
        # Women|Post
        means_women_post[i] <- boot_obj_women_post$t0
        upper_women_post[i] <- ci_obj_women_post$normal[3]
        lower_women_post[i] <- ci_obj_women_post$normal[2]
        
        # Combine
        means_finrisk <- data.frame(Ferritin = rep(ferritin_values, 3),
                                     means = c(means_men, means_women_pre, means_women_post),
                                     upper = c(upper_men, upper_women_pre, upper_women_post),
                                     lower = c(lower_men, lower_women_pre, lower_women_post),
                                     Gender = c(rep("Men", iterations), rep("Women|Pre", iterations), rep("Women|Post", iterations)))
    
    }
    
    # Save
    saveRDS(means_finrisk, paste0("./data/finrisk_ratio_GlycA", boot_n, ".rds"))
} else {means_finrisk <- readRDS(paste0("./data/finrisk_ratio_GlycA", boot_n, ".rds"))}

if (!file.exists(paste0("./data/health2k_ratio_GlycA", boot_n, ".rds"))) { # run bootstrap only if needed
    
    #############
    #### Health2000
    #############
    
    GlycA_trld <- median(donor_eligible_h2k$GlycA, na.rm = T)
    
    ## Preallocate
    # Men
    means_men <- 1:iterations
    upper_men <- 1:iterations
    lower_men <- 1:iterations
    # Women|Pre
    means_women_pre <- 1:iterations
    upper_women_pre <- 1:iterations
    lower_women_pre <- 1:iterations
    # Women|Post
    means_women_post <- 1:iterations
    upper_women_post <- 1:iterations
    lower_women_post <- 1:iterations

    for (i in 1:iterations) {
    
    #############
    #### Health2000
    #############
    
    ## Compute
    # Men
    boot_obj_men <- boot(donor_eligible_h2k %>% filter(Group == "Men"), statistic = get_ratio_boot, R = boot_n, 
                         var1 = Ferritin, var2 = GlycA, var1_trld = ferritin_values[i], var2_trld = GlycA_trld)
    ci_obj_men <- boot.ci(boot_obj_men, type = "norm")
    # Women|Pre
    boot_obj_women_pre <- boot(donor_eligible_h2k %>% filter(Group == "Women|Pre"), statistic = get_ratio_boot, R = boot_n, 
                               var1 = Ferritin, var2 = GlycA, var1_trld = ferritin_values[i], var2_trld = GlycA_trld)
    ci_obj_women_pre <- boot.ci(boot_obj_women_pre, type = "norm")
    # Women|Post
    boot_obj_women_post <- boot(donor_eligible_h2k %>% filter(Group == "Women|Post"), statistic = get_ratio_boot, R = boot_n, 
                                var1 = Ferritin, var2 = GlycA, var1_trld = ferritin_values[i], var2_trld = GlycA_trld)
    ci_obj_women_post <- boot.ci(boot_obj_women_post, type = "norm")
    
    ## Store
    # Men
    means_men[i] <- boot_obj_men$t0
    upper_men[i] <- ci_obj_men$normal[3]
    lower_men[i] <- ci_obj_men$normal[2]
    # Women|Pre
    means_women_pre[i] <- boot_obj_women_pre$t0
    upper_women_pre[i] <- ci_obj_women_pre$normal[3]
    lower_women_pre[i] <- ci_obj_women_pre$normal[2]
    # Women|Post
    means_women_post[i] <- boot_obj_women_post$t0
    upper_women_post[i] <- ci_obj_women_post$normal[3]
    lower_women_post[i] <- ci_obj_women_post$normal[2]
    
    # Combine
    means_health2k <- data.frame(Ferritin = rep(ferritin_values, 3),
                                 means = c(means_men, means_women_pre, means_women_post),
                                 upper = c(upper_men, upper_women_pre, upper_women_post),
                                 lower = c(lower_men, lower_women_pre, lower_women_post),
                                 Gender = c(rep("Men", iterations), rep("Women|Pre", iterations), rep("Women|Post", iterations)))    
    
    
    }
    
    # Save
    saveRDS(means_health2k, paste0("./data/health2k_ratio_GlycA", boot_n, ".rds"))
} else {means_health2k <- readRDS(paste0("./data/health2k_ratio_GlycA", boot_n, ".rds"))}

```

```{r GlycA_ratio_plot, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 7, fig.height = 8}
finrisk_glycaplt <- ggplot(data = means_finrisk, aes(x = Ferritin, y = means)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, group = Gender, fill = Gender), alpha = .5) +
    geom_line(aes(linetype = Gender, color = Gender)) +
    geom_point(shape = 4) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    scale_fill_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                      limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    theme_minimal() +
    labs(title = "Increase in ratio of people over the population median GlycA",
         subtitle = expression("FinRisk 1997 (1.35" *mu*"mol/l)"),
         y = "Increase (%-p)",
         color = "Marker") + guides(fill = "none", color = "none", linetype = "none") +
    theme(axis.title.x = element_blank()) + labs(Marker = "Gender")
health2k_glycaplt <- ggplot(data = means_health2k, aes(x = Ferritin, y = means)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, group = Gender, fill = Gender), alpha = .5) +
    geom_line(aes(linetype = Gender, color = Gender)) +
    geom_point(shape = 4) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    scale_fill_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                      limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    theme_minimal() +
    labs(subtitle = expression("Health 2000 (1.15" *mu*"mol/l)"),
         y = "Increase (%-p)",
         color = "Gender") + guides(fill = "none", linetype = "none") +
    theme(axis.title.x = element_blank(),
          legend.position = "bottom")

multiplot(finrisk_glycaplt, health2k_glycaplt, cols = 1)
```
```{r ratio_boot_HbA1C_by_subgroup, echo = FALSE}
ferritin_values <- seq(5, 50, 1)
iterations <- length(ferritin_values)
HbA1C_trld <- 42

if (!file.exists(paste0("./data/health2k_ratio_HbA1C", boot_n, ".rds"))) { # run bootstrap only if needed
    
    #############
    #### Health2000
    #############
    
    ## Preallocate
    # Men
    means_men <- 1:iterations
    upper_men <- 1:iterations
    lower_men <- 1:iterations
    # Women|Pre
    means_women_pre <- 1:iterations
    upper_women_pre <- 1:iterations
    lower_women_pre <- 1:iterations
    # Women|Post
    means_women_post <- 1:iterations
    upper_women_post <- 1:iterations
    lower_women_post <- 1:iterations

    for (i in 1:iterations) {
    
    #############
    #### Health2000
    #############
    
    ## Compute
    # Men
    boot_obj_men <- boot(donor_eligible_h2k %>% filter(Group == "Men"), statistic = get_ratio_boot, R = boot_n, 
                         var1 = Ferritin, var2 = HbA1C, var1_trld = ferritin_values[i], var2_trld = HbA1C_trld)
    ci_obj_men <- boot.ci(boot_obj_men, type = "norm")
    # Women|Pre
    boot_obj_women_pre <- boot(donor_eligible_h2k %>% filter(Group == "Women|Pre"), statistic = get_ratio_boot, R = boot_n, 
                               var1 = Ferritin, var2 = HbA1C, var1_trld = ferritin_values[i], var2_trld = HbA1C_trld)
    ci_obj_women_pre <- boot.ci(boot_obj_women_pre, type = "norm")
    # Women|Post
    boot_obj_women_post <- boot(donor_eligible_h2k %>% filter(Group == "Women|Post"), statistic = get_ratio_boot, R = boot_n, 
                                var1 = Ferritin, var2 = HbA1C, var1_trld = ferritin_values[i], var2_trld = HbA1C_trld)
    ci_obj_women_post <- boot.ci(boot_obj_women_post, type = "norm")
    
    ## Store
    # Men
    means_men[i] <- boot_obj_men$t0
    upper_men[i] <- ci_obj_men$normal[3]
    lower_men[i] <- ci_obj_men$normal[2]
    # Women|Pre
    means_women_pre[i] <- boot_obj_women_pre$t0
    upper_women_pre[i] <- ci_obj_women_pre$normal[3]
    lower_women_pre[i] <- ci_obj_women_pre$normal[2]
    # Women|Post
    means_women_post[i] <- boot_obj_women_post$t0
    upper_women_post[i] <- ci_obj_women_post$normal[3]
    lower_women_post[i] <- ci_obj_women_post$normal[2]
    
    # Combine
    means_health2k <- data.frame(Ferritin = rep(ferritin_values, 3),
                                 means = c(means_men, means_women_pre, means_women_post),
                                 upper = c(upper_men, upper_women_pre, upper_women_post),
                                 lower = c(lower_men, lower_women_pre, lower_women_post),
                                 Gender = c(rep("Men", iterations), rep("Women|Pre", iterations), rep("Women|Post", iterations)))    
    
    
    }
    
    # Save
    saveRDS(means_health2k, paste0("./data/health2k_ratio_HbA1C", boot_n, ".rds"))
} else {means_health2k <- readRDS(paste0("./data/health2k_ratio_HbA1C", boot_n, ".rds"))}

```

```{r HbA1C_ratio_plot, echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.width = 8, fig.height = 7}
health2k_hba1cplt <- ggplot(data = means_health2k, aes(x = Ferritin, y = means)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, group = Gender, fill = Gender), alpha = .5) +
    geom_line(aes(linetype = Gender, color = Gender)) +
    geom_point(shape = 4) +
    scale_color_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                       limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    scale_fill_manual(values = c( "#00BFFF",  "#de2d26", "#ff85a2" ),
                      limits = c( "Men",  "Women|Post", "Women|Pre" )) +
    theme_minimal() +
    labs(title = "Increase in ratio of people over HbA1C 42 mmol/mol",
         subtitle = "Health 2000",
         y = "Increase (%-p)",
         color = "Gender") + guides(fill = "none", linetype = "none") +
    theme(axis.title.x = element_blank(),
          legend.position = "bottom")
health2k_hba1cplt
```
