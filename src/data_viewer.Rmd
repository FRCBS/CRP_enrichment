---
title: "Data Viewer"
author: "Esa Turkulainen"
date: "7.4.2021"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = "~/CRP_enrichment") # set working directory
library(dplyr)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
source("~/CRP_enrichment/src/funcs.R") # load our helper functions
```

We have one cohort of blood donors, FinDonor, and two general population cohorts, FinRisk97 and Health2000.

```{r load_data, echo = FALSE}
# .rdata by Sofie Ekroos, 2021

# Load data on individual donations
load("~/CRP_enrichment/data/r02.fd.bd.all.rdata") # outputs an object called "output" into the environment
indv_donations <- output

# Load FinDonor demographic data
load("~/CRP_enrichment/data/r02ds.donorData.rdata") # outputs an object called "output" into the environment
donorpop <- output 

# Load THL data
# Sofie: thldalta.rdata contains all five THL cohorts, extract FINRISK97 and Health2000 from the others
load("~/CRP_enrichment/data/thldata.rdata")
fr1997 <- thldata$fr1997
h2000 <- thldata$h2000

# Remove leftovers
rm(output)
rm(thldata)
```

The data we have presented as CRP x Ferritin plots. The left hand side presents data as is, the right hand side presents the data after log transform. The positive correlation between CRP and Ferritin is much more obvious when we log transform the data. The Health2000 data has many values set as 0.00 (missing data?), so these values are probably creating the points at -5 (log(0) = -Inf). The FinDonor data requires some attention also: the CRP measurements have not been taken using a high sensitivity method, as we were not interested in "non-elevated" CRP. So, every CRP value under 3 is missing, and here they have been imputed as "2.9". Additionally, the resolution extends only to integers, which creates visible stratification/intervals after the log transformation of the data. The FinDonor is the only data set where the positive correlation is thus not immediately visible.

```{r crp_ferr_all_nonlog, warning = FALSE, fig.height=7, fig.width=10, fig.align = 'center', echo = FALSE}
p1 <- ggplot(data = fr1997, aes(x = FERRITIN, y = CRP)) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "FINRISK97 | CRP x Ferritin",
         subtitle = "No transformation",
         x = "Ferritin",
         y = "CRP")
p1log <- ggplot(data = fr1997, aes(x = log(FERRITIN), y = log(CRP))) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "FINRISK97 | CRP x Ferritin",
         subtitle = "Log transformation",
         x = "Ferritin",
         y = "CRP")
p2 <- ggplot(data = h2000, aes(x = FERRITIINI, y = CRP)) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "Health2000 | CRP x Ferritin",
         subtitle = "No transformation",
         x = "Ferritin",
         y = "CRP")
p2log <- ggplot(data = h2000, aes(x = log(FERRITIINI), y = log(CRP))) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "Health2000 | CRP x Ferritin",
         subtitle = "Log transformation",
         x = "Ferritin",
         y = "CRP")
p3 <- ggplot(data = indv_donations, aes(x = Ferritin, y = CRP)) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "FinDonor longitudinal | CRP x Ferritin",
         subtitle = "No transformation, CRP imputed <3 and as integers",
         x = "Ferritin",
         y = "CRP")
p3log <- ggplot(data = indv_donations, aes(x = log(Ferritin), y = log(CRP))) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "FinDonor longitudinal | CRP x Ferritin",
         subtitle = "Log transformation, CRP imputed <3 and as integers",
         x = "Ferritin",
         y = "CRP")
multiplot(p1, p2, p3, p1log, p2log, p3log, cols = 2)
```

```{r build_median_quantiles, echo = FALSE}
fr97_rel <- median_by_quantile(fr1997, by = "FERRITIN", var = "CRP", n = 10)
h00_rel <- median_by_quantile(h2000, by = "FERRITIINI", var = "CRP", n = 10)
don_rel <- median_by_quantile(indv_donations, by = "Ferritin", var = "CRP", n = 10)
```

Still working with the entire cohorts (no subgroup analysis yet). We sort the data (each cohort separately) by the ferritin measurements and take 10 quantiles from each sorted cohort. If we then take the ferritin and CRP medians from each of the quantiles, we can plot them to examine the relationship in ordinal "categories". This is raw data without transformations. NaNs are stripped.

The positive correlation between ferritin and CRP is obvious in the FINRISK97 and Health2000 cohorts, but as the medians never cross 3, the FinDonor cohort shows nothing.

```{r plot_quantiles, echo=FALSE, fig.height=7, fig.width=7, fig.align = 'center'}
p1 <- ggplot(data = fr97_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "FINRISK97 | Ferritin x CRP medians across 10 quantiles",
         x = "CRP",
         y = "Ferritin")
p2 <- ggplot(data = h00_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "Health2000 | Ferritin x CRP medians across 10 quantiles",
         x = "CRP",
         y = "Ferritin")
p3 <- ggplot(data = don_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "FinDonor | Ferritin x CRP medians across 10 quantiles",
         x = "CRP",
         y = "Ferritin")

multiplot(p1, p2, p3, cols = 1)
```

```{r build_mean_quantiles, echo = FALSE}
fr97_rel <- mean_by_quantile(fr1997, by = "FERRITIN", var = "CRP", n = 10)
h00_rel <- mean_by_quantile(h2000, by = "FERRITIINI", var = "CRP", n = 10)
don_rel <- mean_by_quantile(indv_donations, by = "Ferritin", var = "CRP", n = 10)
```

Analysis of means reveals that the FinDonor CRP x Ferritin behaves similarly.

```{r plot_mean_quantiles, echo=FALSE, fig.height=7, fig.width=7, fig.align = 'center'}
p1 <- ggplot(data = fr97_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "FINRISK97 | Ferritin x CRP means across 10 quantiles",
         x = "CRP",
         y = "Ferritin")
p2 <- ggplot(data = h00_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "Health2000 | Ferritin x CRP means across 10 quantiles",
         x = "CRP",
         y = "Ferritin")
p3 <- ggplot(data = don_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "FinDonor | Ferritin x CRP means across 10 quantiles",
         x = "CRP",
         y = "Ferritin")

multiplot(p1, p2, p3, cols = 1)
```
What happens to CRP when we start filtering donors based on ferritin levels? Let's say (possibly outlandishly) that we want to set the LB of donor ferritin to 30 ug/l. To see the effect, we want to compare the CRP medians/means of population over and under the ferritin LB.

```{r compute_LB_df, echo = FALSE, warning = FALSE}
LB <- 30

fr_over100 <- fr1997 %>%
    select(FERRITIN, CRP) %>%
    filter(FERRITIN >= LB) %>%
    drop_na()
fr_under100 <- fr1997 %>%
    select(FERRITIN, CRP) %>%
    filter(FERRITIN < LB) %>%
    drop_na()
h00_over100 <- h2000 %>%
    select(FERRITIINI, CRP) %>%
    filter(FERRITIINI >= LB) %>%
    drop_na()
h00_under100 <- h2000 %>%
    select(FERRITIINI, CRP) %>%
    filter(FERRITIINI < LB) %>%
    drop_na()
donpop_over100 <- indv_donations %>%
    select(Ferritin, CRP) %>%
    filter(Ferritin >= LB) %>%
    drop_na()
donpop_under100 <- indv_donations %>%
    select(Ferritin, CRP) %>%
    filter(Ferritin < LB) %>%
    drop_na()

means <- c(mean(fr_over100$CRP), mean(fr_under100$CRP), 
           mean(h00_over100$CRP), mean(h00_under100$CRP), 
           mean(donpop_over100$CRP), mean(donpop_under100$CRP)) 
medians <- c(median(fr_over100$CRP), median(fr_under100$CRP), 
             median(h00_over100$CRP), median(h00_under100$CRP), 
             median(donpop_over100$CRP), median(donpop_under100$CRP)) 
groups <- c("FINRISK97", "FINRISK97", "Health2000", "Health2000", "FinDonor", "FinDonor")
subgroups <- rep(c("Over", "Under"), 3)

df_LBdiff <- data.frame(mean = means, median = medians, cohort = groups, ou = subgroups)
```

```{r plot_LB_diff, echo = FALSE, warning = FALSE, fig.height=7, fig.width=7, fig.align = 'center'}
meanplot <- ggplot(data = df_LBdiff, aes(x = cohort, y = mean, fill = ou)) + 
    geom_bar(position = "dodge", stat = "identity") +
    theme_minimal() +
    labs(title = paste("Population CRP mean over and under a ferritin LB of", LB),
         x = "Cohort",
         y = "Mean",
         fill = "LB") +
    scale_fill_manual(values = brewer.pal(4, "RdGy")[c(1, 2)])

medianplot <- ggplot(data = df_LBdiff, aes(x = cohort, y = median, fill = ou)) + 
    geom_bar(position = "dodge", stat = "identity") +
    theme_minimal() +
    labs(title = paste("Population CRP median over and under a ferritin LB of", LB),
         x = "Cohort",
         y = "Median",
         fill = "LB") +
    scale_fill_manual(values = brewer.pal(4, "RdGy")[c(1, 2)])

multiplot(meanplot, medianplot, cols = 1)
```

```{r N_of_inflm, echo = FALSE}
fr_o100_CRP3 <- fr_over100 %>% filter(CRP >= 3)
fr_u100_CRP3 <- fr_under100 %>% filter(CRP >= 3)
h00_o100_CRP3 <- h00_over100 %>% filter(CRP >= 3)
h00_u100_CRP3 <- h00_under100 %>% filter(CRP >= 3)
donpop_o100_CRP3 <- donpop_over100 %>% filter(CRP >= 3)
donpop_u100_CRP3 <- donpop_under100 %>% filter(CRP >= 3)
```

Using ferritin LB of `r LB` ug/l, the share of potential donors in inflammatory risk (e.g. vascular or heart disease, indicated by CRP >= 3 mg/l) increases from `r round(100 * dim(fr_u100_CRP3)[1] / dim(fr_under100)[1], 2)`% to `r round(100 * dim(fr_o100_CRP3)[1] / dim(fr_over100)[1], 2)`% in the FINRISK1997 cohort and from  `r round(100 * dim(h00_u100_CRP3)[1] / dim(h00_under100)[1], 2)`% to `r round(100 * dim(h00_o100_CRP3)[1] / dim(h00_over100)[1], 2)`% in the Health2000 cohort. Within the existing donor population (indicated by the FinDonor cohort) the share goes from `r round(100 * dim(donpop_u100_CRP3)[1] / dim(donpop_under100)[1], 2)`% to `r round(100 * dim(donpop_o100_CRP3)[1] / dim(donpop_over100)[1], 2)`%.

Thinking in reverse, what is the maximum ferritin threshold we could set without increasing the share of donors under inflammation risk?

```{r, echo = FALSE, warning = FALSE, fig.height=7, fig.width=7, fig.align = 'center'}
CRP_UB <- 3
fr_u3 <- fr1997 %>% filter(CRP < CRP_UB) %>% select(FERRITIN, CRP) %>% drop_na()
fr_o3 <- fr1997 %>% filter(CRP >= CRP_UB) %>% select(FERRITIN, CRP) %>% drop_na()
h00_u3 <- h2000 %>% filter(CRP < CRP_UB) %>% select(FERRITIINI, CRP) %>% drop_na()
h00_o3 <- h2000 %>% filter(CRP >= CRP_UB) %>% select(FERRITIINI, CRP) %>% drop_na()
donpop_u3 <- indv_donations %>% filter(CRP < CRP_UB) %>% select(Ferritin, CRP) %>% drop_na()
donpop_o3 <- indv_donations %>% filter(CRP >= CRP_UB) %>% select(Ferritin, CRP) %>% drop_na()

values <- c(fr_u3$FERRITIN, fr_o3$FERRITIN)
groups <- c(rep("Under", dim(fr_u3)[1]), rep("Over", dim(fr_o3)[1]))
fr_ou3_df <- data.frame(ferritin = values, group = groups)

p1 <- ggplot(data = fr_ou3_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("FINRISK97 | Population ferritin density by CRP =", CRP_UB, "mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP", CRP_UB, "mg/l")) +
    xlim(0, 600)

values <- c(h00_u3$FERRITIINI, h00_o3$FERRITIINI)
groups <- c(rep("Under", dim(h00_u3)[1]), rep("Over", dim(h00_o3)[1]))
h00_ou3_df <- data.frame(ferritin = values, group = groups)

p2 <- ggplot(data = h00_ou3_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("Health2000 | Population ferritin density by CRP =", CRP_UB, "mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP", CRP_UB, "mg/l")) +
    xlim(0, 600)

values <- c(donpop_u3$Ferritin, donpop_o3$Ferritin)
groups <- c(rep("Under", dim(donpop_u3)[1]), rep("Over", dim(donpop_o3)[1]))
donpop_ou3_df <- data.frame(ferritin = values, group = groups)

p3 <- ggplot(data = donpop_ou3_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("FinDonor | Population ferritin density by CRP =", CRP_UB, "mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP", CRP_UB, "mg/l")) +
    xlim(0, 600)

multiplot(p1, p2, p3, cols = 1)
```

These density plots indicate that dodging CRP 3 mg/l might not be possible based on ferritin value alone. Do these distributions ever separate?

```{r, echo = FALSE, warning = FALSE, fig.height=7, fig.width=7, fig.align = 'center'}
CRP_UB <- 3
fr_u3 <- fr1997 %>% filter(CRP < CRP_UB) %>% select(FERRITIN, CRP) %>% drop_na()
fr_o3 <- fr1997 %>% filter(CRP >= CRP_UB) %>% select(FERRITIN, CRP) %>% drop_na()
h00_u3 <- h2000 %>% filter(CRP < CRP_UB) %>% select(FERRITIINI, CRP) %>% drop_na()
h00_o3 <- h2000 %>% filter(CRP >= CRP_UB) %>% select(FERRITIINI, CRP) %>% drop_na()
donpop_u3 <- indv_donations %>% filter(CRP < CRP_UB) %>% select(Ferritin, CRP) %>% drop_na()
donpop_o3 <- indv_donations %>% filter(CRP >= CRP_UB) %>% select(Ferritin, CRP) %>% drop_na()

CRP_UB <- 5
fr_u5 <- fr1997 %>% filter(CRP < CRP_UB) %>% select(FERRITIN, CRP) %>% drop_na()
fr_o5 <- fr1997 %>% filter(CRP >= CRP_UB) %>% select(FERRITIN, CRP) %>% drop_na()
h00_u5 <- h2000 %>% filter(CRP < CRP_UB) %>% select(FERRITIINI, CRP) %>% drop_na()
h00_o5 <- h2000 %>% filter(CRP >= CRP_UB) %>% select(FERRITIINI, CRP) %>% drop_na()
donpop_u5 <- indv_donations %>% filter(CRP < CRP_UB) %>% select(Ferritin, CRP) %>% drop_na()
donpop_o5 <- indv_donations %>% filter(CRP >= CRP_UB) %>% select(Ferritin, CRP) %>% drop_na()

CRP_UB <- 10
fr_u10 <- fr1997 %>% filter(CRP < CRP_UB) %>% select(FERRITIN, CRP) %>% drop_na()
fr_o10 <- fr1997 %>% filter(CRP >= CRP_UB) %>% select(FERRITIN, CRP) %>% drop_na()
h00_u10 <- h2000 %>% filter(CRP < CRP_UB) %>% select(FERRITIINI, CRP) %>% drop_na()
h00_o10 <- h2000 %>% filter(CRP >= CRP_UB) %>% select(FERRITIINI, CRP) %>% drop_na()
donpop_u10 <- indv_donations %>% filter(CRP < CRP_UB) %>% select(Ferritin, CRP) %>% drop_na()
donpop_o10 <- indv_donations %>% filter(CRP >= CRP_UB) %>% select(Ferritin, CRP) %>% drop_na()

CRP_UB <- 50
fr_u50 <- fr1997 %>% filter(CRP < CRP_UB) %>% select(FERRITIN, CRP) %>% drop_na()
fr_o50 <- fr1997 %>% filter(CRP >= CRP_UB) %>% select(FERRITIN, CRP) %>% drop_na()
h00_u50 <- h2000 %>% filter(CRP < CRP_UB) %>% select(FERRITIINI, CRP) %>% drop_na()
h00_o50 <- h2000 %>% filter(CRP >= CRP_UB) %>% select(FERRITIINI, CRP) %>% drop_na()
donpop_u50 <- indv_donations %>% filter(CRP < CRP_UB) %>% select(Ferritin, CRP) %>% drop_na()
donpop_o50 <- indv_donations %>% filter(CRP >= CRP_UB) %>% select(Ferritin, CRP) %>% drop_na()

values <- c(fr_u3$FERRITIN, fr_o3$FERRITIN, fr_u5$FERRITIN, fr_o5$FERRITIN,
            fr_u10$FERRITIN, fr_o10$FERRITIN, fr_u50$FERRITIN, fr_o50$FERRITIN)
groups <- c(rep("Under 3", dim(fr_u3)[1]), rep("Over 3", dim(fr_o3)[1]),
            rep("Under 5", dim(fr_u5)[1]), rep("Over 5", dim(fr_o5)[1]),
            rep("Under 10", dim(fr_u10)[1]), rep("Over 10", dim(fr_o10)[1]),
            rep("Under 50", dim(fr_u50)[1]), rep("Over 50", dim(fr_o50)[1]))
fr_ou_df <- data.frame(ferritin = values, group = groups)

p1 <- ggplot(data = fr_ou_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("FINRISK97 | Population ferritin density by CRP mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP mg/l")) +
    xlim(0, 600)

values <- c(h00_u3$FERRITIINI, h00_o3$FERRITIINI, h00_u5$FERRITIINI, h00_o5$FERRITIINI,
            h00_u10$FERRITIINI, h00_o10$FERRITIINI, h00_u50$FERRITIINI, h00_o50$FERRITIINI)
groups <- c(rep("Under 3", dim(h00_u3)[1]), rep("Over 3", dim(h00_o3)[1]),
            rep("Under 5", dim(h00_u5)[1]), rep("Over 5", dim(h00_o5)[1]),
            rep("Under 10", dim(h00_u10)[1]), rep("Over 10", dim(h00_o10)[1]),
            rep("Under 50", dim(h00_u50)[1]), rep("Over 50", dim(h00_o50)[1]))
h00_ou_df <- data.frame(ferritin = values, group = groups)

p2 <- ggplot(data = h00_ou_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("Health2000 | Population ferritin density by CRP mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP mg/l")) +
    xlim(0, 600)

values <- c(donpop_u3$Ferritin, donpop_o3$Ferritin, donpop_u5$Ferritin, donpop_o5$Ferritin,
            donpop_u10$Ferritin, donpop_o10$Ferritin, donpop_u50$Ferritin, donpop_o50$Ferritin)
groups <- c(rep("Under 3", dim(donpop_u3)[1]), rep("Over 3", dim(donpop_o3)[1]),
            rep("Under 5", dim(donpop_u5)[1]), rep("Over 5", dim(donpop_o5)[1]),
            rep("Under 10", dim(donpop_u10)[1]), rep("Over 10", dim(donpop_o10)[1]),
            rep("Under 50", dim(donpop_u50)[1]), rep("Over 50", dim(donpop_o50)[1]))
donpop_ou_df <- data.frame(ferritin = values, group = groups)

p3 <- ggplot(data = donpop_ou_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("FinDonor | Population ferritin density by CRP mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP mg/l")) +
    xlim(0, 600)

multiplot(p1, p2, p3, cols = 1)
```

