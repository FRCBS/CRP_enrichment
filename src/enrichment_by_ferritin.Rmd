---
title: "Enrichment by ferritin guiding"
author: "Esa Turkulainen"
date: "7.4.2021"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = "~/CRP_enrichment") # set working directory
library(dplyr)
library(tidyverse)
library(boot)
library(ggplot2)
library(RColorBrewer)
source("~/CRP_enrichment/src/funcs.R") # load our helper functions

# set number of bootstrap iterations
boot_n <- 10000
```

We have one cohort of blood donors, FinDonor, and two general population cohorts, FinRisk97 and Health2000. The FinDonor cohort does not include the variables of interest, so we'll use data from individual donations (by donors), which is cross-referenceable to the FinDonor set.

```{r load_data, echo = FALSE}
# .rdata by Sofie Ekroos, 2021

# Load data on individual donations
load("~/CRP_enrichment/data/r02.fd.bd.all.rdata") # outputs an object called "output" into the environment
donations <- output

# Load FinDonor demographic data
load("~/CRP_enrichment/data/r02ds.donorData.rdata") # outputs an object called "output" into the environment
findonor <- output 

# Load THL data
# Sofie: thldalta.rdata contains all five THL cohorts, extract FINRISK97 and Health2000 from the others
load("~/CRP_enrichment/data/thldata.rdata")
fr1997 <- thldata$fr1997
h2000 <- thldata$h2000

# Remove leftovers
rm(output)
rm(thldata)

# We only want to look at first donation event values from each donor
donors <- donations %>%
    group_by(donor) %>%
    filter(date == min(date)) %>%
    ungroup()
```

# Warmup | Getting to know the data

The data we have presented as CRP x Ferritin plots. The left hand side presents data as is, the right hand side presents the data after log transform. The positive correlation between CRP and Ferritin is much more obvious when we log transform the data. The Health2000 data has many values set as 0.00 (missing data?), so these values are probably creating the points at -5 (log(0) = -Inf). The FinDonor data requires some attention also: the CRP measurements have not been taken using a high sensitivity method, as we were not interested in "non-elevated" CRP. So, every CRP value under 3 is missing, and here they have been imputed as "2.9". Additionally, the resolution extends only to integers, which creates visible stratification/intervals after the log transformation of the data. The FinDonor is the only data set where the positive correlation is thus not immediately visible.

```{r crp_ferr_all_nonlog, warning = FALSE, fig.height=7, fig.width=10, fig.align = 'center', echo = FALSE}
p1 <- ggplot(data = fr1997, aes(x = FERRITIN, y = CRP)) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "FINRISK97 | CRP x Ferritin",
         subtitle = "No transformation",
         x = "Ferritin",
         y = "CRP")
p1log <- ggplot(data = fr1997, aes(x = log(FERRITIN), y = log(CRP))) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "FINRISK97 | CRP x Ferritin",
         subtitle = "Log transformation",
         x = "Ferritin",
         y = "CRP")
p2 <- ggplot(data = h2000, aes(x = FERRITIINI, y = CRP)) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "Health2000 | CRP x Ferritin",
         subtitle = "No transformation",
         x = "Ferritin",
         y = "CRP")
p2log <- ggplot(data = h2000, aes(x = log(FERRITIINI), y = log(CRP))) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "Health2000 | CRP x Ferritin",
         subtitle = "Log transformation",
         x = "Ferritin",
         y = "CRP")
p3 <- ggplot(data = donors, aes(x = Ferritin, y = CRP)) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "Donor data | CRP x Ferritin",
         subtitle = "No transformation, CRP imputed <3 and as integers",
         x = "Ferritin",
         y = "CRP")
p3log <- ggplot(data = donors, aes(x = log(Ferritin), y = log(CRP))) + 
    geom_point(alpha = 0.05) +
    theme_minimal() +
    labs(title = "Donor data | CRP x Ferritin",
         subtitle = "Log transformation, CRP imputed <3 and as integers",
         x = "Ferritin",
         y = "CRP")
multiplot(p1, p2, p3, p1log, p2log, p3log, cols = 2)
```

```{r build_median_quantiles, echo = FALSE}
fr97_rel <- median_by_quantile(fr1997, by = "FERRITIN", var = "CRP", n = 10)
h00_rel <- median_by_quantile(h2000, by = "FERRITIINI", var = "CRP", n = 10)
don_rel <- median_by_quantile(donors, by = "Ferritin", var = "CRP", n = 10)
```

Still working with the entire cohorts (no subgroup analysis yet). We sort the data (each cohort separately) by the ferritin measurements and take 10 quantiles from each sorted cohort. If we then take the ferritin and CRP medians from each of the quantiles, we can plot them to examine the relationship in ordinal "categories". This is raw data without transformations. NaNs are stripped.

The positive correlation between ferritin and CRP is obvious in the FINRISK97 and Health2000 cohorts, but as the medians never cross 3, the FinDonor cohort shows nothing.

```{r plot_quantiles, echo=FALSE, fig.height=7, fig.width=7, fig.align = 'center'}
p1 <- ggplot(data = fr97_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "FINRISK97 | Ferritin x CRP medians across 10 quantiles",
         x = "CRP",
         y = "Ferritin")
p2 <- ggplot(data = h00_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "Health2000 | Ferritin x CRP medians across 10 quantiles",
         x = "CRP",
         y = "Ferritin")
p3 <- ggplot(data = don_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "Donor data | Ferritin x CRP medians across 10 quantiles",
         x = "CRP",
         y = "Ferritin")

multiplot(p1, p2, p3, cols = 1)
```

```{r build_mean_quantiles, echo = FALSE}
fr97_rel <- mean_by_quantile(fr1997, by = "FERRITIN", var = "CRP", n = 10)
h00_rel <- mean_by_quantile(h2000, by = "FERRITIINI", var = "CRP", n = 10)
don_rel <- mean_by_quantile(donors, by = "Ferritin", var = "CRP", n = 10)
```

Analysis of means reveals that the FinDonor CRP x Ferritin behaves similarly.

```{r plot_mean_quantiles, echo=FALSE, fig.height=7, fig.width=7, fig.align = 'center'}
p1 <- ggplot(data = fr97_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "FINRISK97 | Ferritin x CRP means across 10 quantiles",
         x = "CRP",
         y = "Ferritin")
p2 <- ggplot(data = h00_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "Health2000 | Ferritin x CRP means across 10 quantiles",
         x = "CRP",
         y = "Ferritin")
p3 <- ggplot(data = don_rel, aes(x = var, y = by)) + 
    geom_point() +
    theme_minimal() +
    labs(title = "FinDonor | Ferritin x CRP means across 10 quantiles",
         x = "CRP",
         y = "Ferritin")

multiplot(p1, p2, p3, cols = 1)
```
What happens to CRP when we start filtering donors based on ferritin levels? Let's say that we want to set the LB of donor ferritin to 30 ug/l. To see the effect, we want to compare the CRP medians/means of population filtered and not filtered by the ferritin LB.

```{r compute_LB_df, echo = FALSE, warning = FALSE}
LB <- 30

frfil <- fr1997 %>%
    select(FERRITIN, CRP) %>%
    filter(FERRITIN >= LB) %>%
    drop_na()
fr <- fr1997 %>%
    select(FERRITIN, CRP) %>%
    drop_na()
h00fil <- h2000 %>%
    select(FERRITIINI, CRP) %>%
    filter(FERRITIINI >= LB) %>%
    drop_na()
h00 <- h2000 %>%
    select(FERRITIINI, CRP) %>%
    drop_na()
donfil <- donors %>%
    select(Ferritin, CRP) %>%
    filter(Ferritin >= LB) %>%
    drop_na()
don <- donors %>%
    select(Ferritin, CRP) %>%
    drop_na()

means <- c(mean(frfil$CRP), mean(fr$CRP), 
           mean(h00fil$CRP), mean(h00$CRP), 
           mean(donfil$CRP), mean(don$CRP)) 
medians <- c(median(frfil$CRP), median(fr$CRP), 
             median(h00fil$CRP), median(h00$CRP), 
             median(donfil$CRP), median(don$CRP)) 
groups <- c("FINRISK97", "FINRISK97", "Health2000", "Health2000", "Donor data", "Donor data")
subgroups <- rep(c("Yes", "No"), 3)

df_LBdiff <- data.frame(mean = means, median = medians, cohort = groups, filtered = subgroups)
```

```{r plot_LB_diff, echo = FALSE, warning = FALSE, fig.height=7, fig.width=7, fig.align = 'center'}
meanplot <- ggplot(data = df_LBdiff, aes(x = cohort, y = mean, fill = filtered)) + 
    geom_bar(position = "dodge", stat = "identity") +
    theme_minimal() +
    labs(title = paste("Population CRP mean if filtered by ferritin LB of", LB),
         x = "Cohort",
         y = "Mean",
         fill = "LB") +
    scale_fill_manual(values = brewer.pal(4, "RdGy")[c(1, 2)])

medianplot <- ggplot(data = df_LBdiff, aes(x = cohort, y = median, fill = filtered)) + 
    geom_bar(position = "dodge", stat = "identity") +
    theme_minimal() +
    labs(title = paste("Population CRP median if filtered by ferritin LB of", LB),
         x = "Cohort",
         y = "Median",
         fill = "LB") +
    scale_fill_manual(values = brewer.pal(4, "RdGy")[c(1, 2)])

multiplot(meanplot, medianplot, cols = 1)
```

```{r N_of_inflm, echo = FALSE}
CRP_LB <- 3
fr_o_CRPLB <- frfil %>% filter(CRP >= CRP_LB)
fr_u_CRPLB <- fr %>% filter(CRP >= CRP_LB)
h00_o_CRPLB <- h00fil %>% filter(CRP >= CRP_LB)
h00_u_CRPLB <- h00 %>% filter(CRP >= CRP_LB)
don_o_CRPLB <- donfil %>% filter(CRP >= CRP_LB)
don_u_CRPLB <- don %>% filter(CRP >= CRP_LB)
```

Using ferritin LB of `r LB` ug/l, the share of potential donors in inflammatory risk (e.g. vascular or heart disease, indicated by CRP >= 3 mg/l) increases from `r round(100 * dim(fr_u_CRPLB)[1] / dim(fr)[1], 2)`% to `r round(100 * dim(fr_o_CRPLB)[1] / dim(frfil)[1], 2)`% in the FINRISK1997 cohort and from  `r round(100 * dim(h00_u_CRPLB)[1] / dim(h00)[1], 2)`% to `r round(100 * dim(h00_o_CRPLB)[1] / dim(h00fil)[1], 2)`% in the Health2000 cohort. Within the existing donor population (indicated by the FinDonor cohort) the share goes from `r round(100 * dim(don_u_CRPLB)[1] / dim(don)[1], 2)`% to `r round(100 * dim(don_o_CRPLB)[1] / dim(donfil)[1], 2)`%.

Thinking in reverse, what is the maximum ferritin threshold we could set without increasing the share of donors under inflammation risk?

```{r, echo = FALSE, warning = FALSE, fig.height=7, fig.width=7, fig.align = 'center'}
CRP_th <- 3
fr_uth <- fr1997 %>% filter(CRP < CRP_th) %>% select(FERRITIN, CRP) %>% drop_na()
fr_oth <- fr1997 %>% filter(CRP >= CRP_th) %>% select(FERRITIN, CRP) %>% drop_na()
h00_uth <- h2000 %>% filter(CRP < CRP_th) %>% select(FERRITIINI, CRP) %>% drop_na()
h00_oth <- h2000 %>% filter(CRP >= CRP_th) %>% select(FERRITIINI, CRP) %>% drop_na()
don_uth <- donors %>% filter(CRP < CRP_th) %>% select(Ferritin, CRP) %>% drop_na()
don_oth <- donors %>% filter(CRP >= CRP_th) %>% select(Ferritin, CRP) %>% drop_na()

values <- c(fr_uth$FERRITIN, fr_oth$FERRITIN)
groups <- c(rep("Under", dim(fr_uth)[1]), rep("Over", dim(fr_oth)[1]))
fr_outh_df <- data.frame(ferritin = values, group = groups)

p1 <- ggplot(data = fr_outh_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("FINRISK97 | Population ferritin density by CRP =", CRP_th, "mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP", CRP_th, "mg/l")) +
    xlim(0, 600)

values <- c(h00_uth$FERRITIINI, h00_oth$FERRITIINI)
groups <- c(rep("Under", dim(h00_uth)[1]), rep("Over", dim(h00_oth)[1]))
h00_outh_df <- data.frame(ferritin = values, group = groups)

p2 <- ggplot(data = h00_outh_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("Health2000 | Population ferritin density by CRP =", CRP_th, "mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP", CRP_th, "mg/l")) +
    xlim(0, 600)

values <- c(don_uth$Ferritin, don_oth$Ferritin)
groups <- c(rep("Under", dim(don_uth)[1]), rep("Over", dim(don_oth)[1]))
don_outh_df <- data.frame(ferritin = values, group = groups)

p3 <- ggplot(data = don_outh_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("FinDonor | Population ferritin density by CRP =", CRP_th, "mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP", CRP_th, "mg/l")) +
    xlim(0, 600)

multiplot(p1, p2, p3, cols = 1)
```

These density plots indicate that dodging CRP 3 mg/l might not be possible based on ferritin value alone. Do these distributions ever separate?

```{r, echo = FALSE, warning = FALSE, fig.height=7, fig.width=7, fig.align = 'center'}
CRP_th <- 3
fr_uth <- fr1997 %>% filter(CRP < CRP_th) %>% select(FERRITIN, CRP) %>% drop_na()
fr_oth <- fr1997 %>% filter(CRP >= CRP_th) %>% select(FERRITIN, CRP) %>% drop_na()
h00_uth <- h2000 %>% filter(CRP < CRP_th) %>% select(FERRITIINI, CRP) %>% drop_na()
h00_oth <- h2000 %>% filter(CRP >= CRP_th) %>% select(FERRITIINI, CRP) %>% drop_na()
don_uth <- donors %>% filter(CRP < CRP_th) %>% select(Ferritin, CRP) %>% drop_na()
don_oth <- donors %>% filter(CRP >= CRP_th) %>% select(Ferritin, CRP) %>% drop_na()

CRP_th <- 5
fr_u5 <- fr1997 %>% filter(CRP < CRP_th) %>% select(FERRITIN, CRP) %>% drop_na()
fr_o5 <- fr1997 %>% filter(CRP >= CRP_th) %>% select(FERRITIN, CRP) %>% drop_na()
h00_u5 <- h2000 %>% filter(CRP < CRP_th) %>% select(FERRITIINI, CRP) %>% drop_na()
h00_o5 <- h2000 %>% filter(CRP >= CRP_th) %>% select(FERRITIINI, CRP) %>% drop_na()
don_u5 <- donors %>% filter(CRP < CRP_th) %>% select(Ferritin, CRP) %>% drop_na()
don_o5 <- donors %>% filter(CRP >= CRP_th) %>% select(Ferritin, CRP) %>% drop_na()

CRP_th <- 10
fr_u10 <- fr1997 %>% filter(CRP < CRP_th) %>% select(FERRITIN, CRP) %>% drop_na()
fr_o10 <- fr1997 %>% filter(CRP >= CRP_th) %>% select(FERRITIN, CRP) %>% drop_na()
h00_u10 <- h2000 %>% filter(CRP < CRP_th) %>% select(FERRITIINI, CRP) %>% drop_na()
h00_o10 <- h2000 %>% filter(CRP >= CRP_th) %>% select(FERRITIINI, CRP) %>% drop_na()
don_u10 <- donors %>% filter(CRP < CRP_th) %>% select(Ferritin, CRP) %>% drop_na()
don_o10 <- donors %>% filter(CRP >= CRP_th) %>% select(Ferritin, CRP) %>% drop_na()

CRP_th <- 50
fr_u50 <- fr1997 %>% filter(CRP < CRP_th) %>% select(FERRITIN, CRP) %>% drop_na()
fr_o50 <- fr1997 %>% filter(CRP >= CRP_th) %>% select(FERRITIN, CRP) %>% drop_na()
h00_u50 <- h2000 %>% filter(CRP < CRP_th) %>% select(FERRITIINI, CRP) %>% drop_na()
h00_o50 <- h2000 %>% filter(CRP >= CRP_th) %>% select(FERRITIINI, CRP) %>% drop_na()
don_u50 <- donors %>% filter(CRP < CRP_th) %>% select(Ferritin, CRP) %>% drop_na()
don_o50 <- donors %>% filter(CRP >= CRP_th) %>% select(Ferritin, CRP) %>% drop_na()

values <- c(fr_uth$FERRITIN, fr_oth$FERRITIN, fr_u5$FERRITIN, fr_o5$FERRITIN,
            fr_u10$FERRITIN, fr_o10$FERRITIN, fr_u50$FERRITIN, fr_o50$FERRITIN)
groups <- c(rep("Under 3", dim(fr_uth)[1]), rep("Over 3", dim(fr_oth)[1]),
            rep("Under 5", dim(fr_u5)[1]), rep("Over 5", dim(fr_o5)[1]),
            rep("Under 10", dim(fr_u10)[1]), rep("Over 10", dim(fr_o10)[1]),
            rep("Under 50", dim(fr_u50)[1]), rep("Over 50", dim(fr_o50)[1]))
fr_ou_df <- data.frame(ferritin = values, group = groups)

p1 <- ggplot(data = fr_ou_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("FINRISK97 | Population ferritin density by CRP mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP mg/l")) +
    xlim(0, 600)

values <- c(h00_uth$FERRITIINI, h00_oth$FERRITIINI, h00_u5$FERRITIINI, h00_o5$FERRITIINI,
            h00_u10$FERRITIINI, h00_o10$FERRITIINI, h00_u50$FERRITIINI, h00_o50$FERRITIINI)
groups <- c(rep("Under 3", dim(h00_uth)[1]), rep("Over 3", dim(h00_oth)[1]),
            rep("Under 5", dim(h00_u5)[1]), rep("Over 5", dim(h00_o5)[1]),
            rep("Under 10", dim(h00_u10)[1]), rep("Over 10", dim(h00_o10)[1]),
            rep("Under 50", dim(h00_u50)[1]), rep("Over 50", dim(h00_o50)[1]))
h00_ou_df <- data.frame(ferritin = values, group = groups)

p2 <- ggplot(data = h00_ou_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("Health2000 | Population ferritin density by CRP mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP mg/l")) +
    xlim(0, 600)

values <- c(don_uth$Ferritin, don_oth$Ferritin, don_u5$Ferritin, don_o5$Ferritin,
            don_u10$Ferritin, don_o10$Ferritin, don_u50$Ferritin, don_o50$Ferritin)
groups <- c(rep("Under 3", dim(don_uth)[1]), rep("Over 3", dim(don_oth)[1]),
            rep("Under 5", dim(don_u5)[1]), rep("Over 5", dim(don_o5)[1]),
            rep("Under 10", dim(don_u10)[1]), rep("Over 10", dim(don_o10)[1]),
            rep("Under 50", dim(don_u50)[1]), rep("Over 50", dim(don_o50)[1]))
don_ou_df <- data.frame(ferritin = values, group = groups)

p3 <- ggplot(data = don_ou_df, aes(x = ferritin, group = group, fill = group)) +
    geom_density(adjust = 1.5, alpha = .4) + 
    theme_minimal() + 
    labs(title = paste("Donor data | Population ferritin density by CRP mg/l"),
         x = "Ferritin",
         y = "Density",
         fill = paste("CRP mg/l")) +
    xlim(0, 600)

multiplot(p1, p2, p3, cols = 1)
```

# Actionable analysis 

## Ferritin x CRP & GlycA & HbA$_{1C}$

```{r filter_h2000, echo = FALSE, warning = FALSE}
# First, we'll filter away people who wouldn't be able to donate.
# We'll now be satisfied with only filtering the Health2000 cohort

h2000_filtered <- h2000 %>% 
    filter(BMII_PAINO.x >= 50 & BMII_PAINO.x <= 200) %>% # Filter away people <50kg and >200kg
    filter(IKA2 >= 18 & IKA2 <= 66) %>% # Filter away too young and too old
    filter((B_Hb >= 125 & SP2 == 2) | (B_Hb >= 135 & SP2 == 1)) # Filter by hemoglobin
```


The plot below shows what happens to common inflammation marker means and medians within the population when we start requiring a certain ferritin threshold for donors. Filter value for ferritin is set to a *lower bound*  of `r LB` ug/l for these analyses. The CRP variable is available in every cohort, but the GP is only found from FINRISK97 and Health200. Finally, the glycated hemoglobin (HbA1C) is only available in the Health2000 cohort.

```{r bootmeanCRP, echo = FALSE, warning = FALSE}
frfilb <- boot(frfil$CRP, bootmean, R = boot_n)
frb <- boot(fr$CRP, bootmean, R = boot_n)
h00filb <- boot(h00fil$CRP, bootmean, R = boot_n)
h00b <- boot(h00$CRP, bootmean, R = boot_n)
donfilb <- boot(donfil$CRP, bootmean, R = boot_n)
donb <- boot(don$CRP, bootmean, R = boot_n)

frfilci <- boot.ci(frfilb, type = "norm")
frci <- boot.ci(frb, type = "norm")
h00filci <- boot.ci(h00filb, type = "norm")
h00ci <- boot.ci(h00b, type = "norm")
donfilci <- boot.ci(donfilb, type = "norm")
donci <- boot.ci(donb, type = "norm")

bootmeandf <- data.frame(mean = c(frb$t0, frfilb$t0, h00b$t0, h00filb$t0, donb$t0, donfilb$t0),
                         lower = c(frci$normal[2], frfilci$normal[2], h00ci$normal[2], h00filci$normal[2], donci$normal[2], donfilci$normal[2]),
                         upper = c(frci$normal[3], frfilci$normal[3], h00ci$normal[3], h00filci$normal[3], donci$normal[3], donfilci$normal[3]),
                         filter = rep(c("Unfiltered", "Filtered"), 3),
                         cohort = c(rep("FINRISK97", 2), rep("Health2000", 2), rep("Donor data", 2)),
                         plotorder = c(1, 1.5, 2.5, 3, 4, 4.5))
```

```{r bootmeanCRP_plot, echo = FALSE, fig.height=5, fig.width=8, fig.align = 'center'}
CRP_mean_p <- ggplot(data = bootmeandf, aes(x = mean, y = plotorder)) + 
    geom_errorbarh(aes(xmin = lower, xmax = upper, color = filter), height = 0.1) +
    geom_point() +
    theme_minimal() +
    scale_y_reverse() +
    geom_text(aes(x = 0, y = plotorder, label = paste(cohort, "|", filter, "| Mean:", round(mean, 2))), size = 4, hjust = "inward") +
    theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), legend.position = "none") +
    labs(title = "Population CRP mean by cohort and whether selected by ferritin >30 ug/l", 
         subtitle = "95 % confidence interval (bootstrap)",
         x = "Mean", 
         color = "Ferritin > 30 ug/l")
```

```{r bootmedianCRP, echo = FALSE, warning = FALSE}
frfilmd <- boot(frfil$CRP, bootmedian, R = boot_n)
frmd <- boot(fr$CRP, bootmedian, R = boot_n)
h00filmd <- boot(h00fil$CRP, bootmedian, R = boot_n)
h00md <- boot(h00$CRP, bootmedian, R = boot_n)
#donpop_omd <- boot(donpop_over$CRP, bootmedian, R = boot_n)
#donpop_umd <- boot(donpop_under$CRP, bootmedian, R = boot_n)

frfilcimd <- boot.ci(frfilmd, type = "norm")
frcimd <- boot.ci(frmd, type = "norm")
h00filcimd <- boot.ci(h00filmd, type = "norm")
h00cimd <- boot.ci(h00md, type = "norm")
#donpop_o_cimd <- boot.ci(donpop_omd, type = "norm") "All values of t are equal to  2.9 \n Cannot calculate confidence intervals"
#donpop_u_cimd <- boot.ci(donpop_umd, type = "norm") "All values of t are equal to  2.9 \n Cannot calculate confidence intervals"

bootmediandf <- data.frame(median = c(frmd$t0, frfilmd$t0, h00md$t0, h00filmd$t0),
                         lower = c(frcimd$normal[2], frfilcimd$normal[2], h00cimd$normal[2], h00filcimd$normal[2]),
                         upper = c(frcimd$normal[3], frfilcimd$normal[3], h00cimd$normal[3], h00filcimd$normal[3]),
                         filter = rep(c("Unfiltered", "Filtered"), 2),
                         cohort = c(rep("FINRISK97", 2), rep("Health2000", 2)),
                         plotorder = c(0.6, 0.8, 1.2, 1.4))
```


```{r bootmedianCRP_plot, echo = FALSE, fig.height=5, fig.width=8, fig.align = 'center'}
CRP_median_p <- ggplot(data = bootmediandf, aes(x = median, y = plotorder)) + 
    geom_errorbarh(aes(xmin = lower, xmax = upper, color = filter), height = 0.06) +
    geom_point() +
    theme_minimal() +
    ylim(c(2, 0)) +
    geom_text(aes(x = 0, y = plotorder, label = paste(cohort, "|", filter, "| Median:", round(median, 2))), size = 4, hjust = "inward") +
    theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), legend.position = "none") +
    labs(title = "Population CRP median by cohort and whether selected by ferritin >30 ug/l", 
         subtitle = "95 % confidence interval (bootstrap) | Donor data not included due to insufficient data",
         x = "Median", 
         color = "Ferritin > 30 ug/l")
```


```{r GPdata, echo = FALSE}
LB <- 30

frGPfil <- fr1997 %>%
    select(FERRITIN, GP) %>%
    filter(FERRITIN >= LB) %>%
    drop_na()
frGP <- fr1997 %>%
    select(FERRITIN, GP) %>%
    drop_na()
h00GPfil <- h2000 %>%
    select(FERRITIINI, GP) %>%
    filter(FERRITIINI >= LB) %>%
    drop_na()
h00GP <- h2000 %>%
    select(FERRITIINI, GP) %>%
    drop_na()
```


```{r bootmeanGP, echo = FALSE, warning = FALSE}
frGPfilb <- boot(frGPfil$GP, bootmean, R = boot_n)
frGPb <- boot(frGP$GP, bootmean, R = boot_n)
h00GPfilb <- boot(h00GPfil$GP, bootmean, R = boot_n)
h00GPb <- boot(h00GP$GP, bootmean, R = boot_n)

frGPfilci <- boot.ci(frGPfilb, type = "norm")
frGPci <- boot.ci(frGPb, type = "norm")
h00GPfilci <- boot.ci(h00GPfilb, type = "norm")
h00GPci <- boot.ci(h00GPb, type = "norm")

GPbootmeandf <- data.frame(mean = c(frGPb$t0, frGPfilb$t0, h00GPb$t0, h00GPfilb$t0),
                         lower = c(frGPci$normal[2], frGPfilci$normal[2], h00GPci$normal[2], h00GPfilci$normal[2]),
                         upper = c(frGPci$normal[3], frGPfilci$normal[3], h00GPci$normal[3], h00GPfilci$normal[3]),
                         filter = rep(c("Unfiltered", "Filtered"), 2),
                         cohort = c(rep("FINRISK97", 2), rep("Health2000", 2)),
                         plotorder = c(0.6, 0.8, 1.2, 1.4))
```

```{r bootmeanGP_plot, echo = FALSE, fig.height=5, fig.width=8, fig.align = 'center'}
GP_mean_p <- ggplot(data = GPbootmeandf, aes(x = mean, y = plotorder)) + 
    geom_errorbarh(aes(xmin = lower, xmax = upper, color = filter), height = 0.2) +
    geom_point() +
    theme_minimal() +
    ylim(c(2, 0)) +
    geom_text(aes(x = 0, y = plotorder, label = paste(cohort, "|", filter, "| Mean:", round(mean, 2))), size = 4, hjust = "inward") +
    theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), legend.position = "none") +
    labs(title = "Population GlycA mean by cohort and whether selected by ferritin >30 ug/l", 
         subtitle = "95 % confidence interval (bootstrap)",
         x = "Mean", 
         color = "Ferritin > 30 ug/l")
```

```{r bootmedianGP, echo = FALSE, warning = FALSE}
frGPfilmd <- boot(frGPfil$GP, bootmedian, R = boot_n)
frGPmd <- boot(frGP$GP, bootmedian, R = boot_n)
h00GPfilmd <- boot(h00GPfil$GP, bootmedian, R = boot_n)
h00GPmd <- boot(h00GP$GP, bootmedian, R = boot_n)

frGPfilcimd <- boot.ci(frGPfilmd, type = "norm")
frGPcimd <- boot.ci(frGPmd, type = "norm")
h00GPfilcimd <- boot.ci(h00GPfilmd, type = "norm")
h00GPcimd <- boot.ci(h00GPmd, type = "norm")

GPbootmediandf <- data.frame(median = c(frGPmd$t0, frGPfilmd$t0, h00GPmd$t0, h00GPfilmd$t0),
                         lower = c(frGPcimd$normal[2], frGPfilcimd$normal[2], h00GPcimd$normal[2], h00GPfilcimd$normal[2]),
                         upper = c(frGPcimd$normal[3], frGPfilcimd$normal[3], h00GPcimd$normal[3], h00GPfilcimd$normal[3]),
                         filter = rep(c("Unfiltered", "Filtered"), 2),
                         cohort = c(rep("FINRISK97", 2), rep("Health2000", 2)),
                         plotorder = c(0.6, 0.8, 1.2, 1.4))
```

```{r bootmedianGP_plot, echo = FALSE, fig.height=5, fig.width=8, fig.align = 'center'}
GP_median_p <- ggplot(data = GPbootmediandf, aes(x = median, y = plotorder)) + 
    geom_errorbarh(aes(xmin = lower, xmax = upper, color = filter), height = 0.06) +
    geom_point() +
    theme_minimal() +
    ylim(c(2, 0)) +
    geom_text(aes(x = 0, y = plotorder, label = paste(cohort, "|", filter, "| Median:", round(median, 2))), size = 4, hjust = "inward") +
    theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), legend.position = "none") +
    labs(title = "Population GlycA median by cohort and whether selected by ferritin >30 ug/l", 
         subtitle = "95 % confidence interval (bootstrap) | Donor data not included due to insufficient data",
         x = "Median", 
         color = "Ferritin > 30 ug/l")
```

```{r HbAdata, echo = FALSE}
LB <- 30

h00HbAfil <- h2000 %>%
    mutate(HbAmm = B_GHb_A1C * 10.93 - 23.50) %>% # https://www.terveyskirjasto.fi/pgt00014/hba1c-muuntolaskuri
    select(FERRITIINI, HbAmm) %>%
    filter(FERRITIINI >= LB) %>%
    drop_na()

h00HbA <- h2000 %>%
    mutate(HbAmm = B_GHb_A1C * 10.93 - 23.50) %>% 
    select(FERRITIINI, HbAmm) %>%
    drop_na()
```

```{r bootmeanHbA, echo = FALSE, warning = FALSE}
h00HbAfilb <- boot(h00HbAfil$HbAmm, bootmean, R = boot_n)
h00HbAb <- boot(h00HbA$HbAmm, bootmean, R = boot_n)

h00HbAfilci <- boot.ci(h00HbAfilb, type = "norm")
h00HbAci <- boot.ci(h00HbAb, type = "norm")

HbAbootmeandf <- data.frame(mean = c(h00HbAb$t0, h00HbAfilb$t0),
                         lower = c(h00HbAci$normal[2], h00HbAfilci$normal[2]),
                         upper = c(h00HbAci$normal[3], h00HbAfilci$normal[3]),
                         filter = c("Unfiltered", "Filtered"),
                         cohort = c(rep("Health2000", 2)),
                         plotorder = c(0.9, 1.1))
```

```{r bootmeanHbA_plot, echo = FALSE, fig.height=5, fig.width=8, fig.align = 'center'}
HbA_mean_p <- ggplot(data = HbAbootmeandf, aes(x = mean, y = plotorder)) + 
    geom_errorbarh(aes(xmin = lower, xmax = upper, color = filter), height = 0.1) +
    geom_point() +
    theme_minimal() +
    ylim(c(2, 0)) +
    xlim(c(20, 40)) +
    geom_text(aes(x = 20, y = plotorder, label = paste(cohort, "|", filter, "| Mean:", round(mean, 2))), size = 4, hjust = "inward") +
    theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), legend.position = "none") +
    labs(title = "Population HbA1C (mmol/mol) mean by cohort and whether selected by ferritin >30 ug/l", 
         subtitle = "95 % confidence interval (bootstrap)",
         x = "Mean", 
         color = "Ferritin > 30 ug/l")
```

```{r bootmedianHbA, echo = FALSE, warning = FALSE}
h00HbAfilmd <- boot(h00HbAfil$HbAmm, bootmedian, R = boot_n)
h00HbAmd <- boot(h00HbA$HbAmm, bootmedian, R = boot_n)

h00HbAfilcimd <- boot.ci(h00HbAfilmd, type = "norm")
#h00HbAcimd <- boot.ci(h00HbAmd, type = "norm")

HbAbootmediandf <- data.frame(median = c(h00HbAmd$t0, h00HbAfilmd$t0),
                         lower = c(h00HbAmd$t0, h00HbAfilcimd$normal[2]),
                         upper = c(h00HbAmd$t0, h00HbAfilcimd$normal[3]),
                         filter = c("Unfiltered", "Filtered"),
                         cohort = c(rep("Health2000", 2)),
                         plotorder = c(0.9, 1.1))
```

```{r bootmedianHbA_plot, echo = FALSE, fig.height=5, fig.width=8, fig.align = 'center'}
HbA_median_p <- ggplot(data = HbAbootmediandf, aes(x = median, y = plotorder)) + 
    geom_errorbarh(aes(xmin = lower, xmax = upper, color = filter), height = 0.2) +
    geom_point() +
    theme_minimal() +
    ylim(c(2, 0)) +
    xlim(c(20, 40)) +
    geom_text(aes(x = 20, y = plotorder, label = paste(cohort, "|", filter, "| Median:", round(median, 2))), size = 4, hjust = "inward") +
    theme(axis.title.y = element_blank(), axis.ticks.y = element_blank(), axis.text.y = element_blank(), legend.position = "none") +
    labs(title = "Population HbA1C (mmol/mol) median in Health2000, whether selected by ferritin >30 ug/l",
         subtitle = "95 % confidence interval (bootstrap) | No interval for unfiltered (all values the same)",
         x = "Median",
         color = "Ferritin > 30 ug/l")
```

```{r LBresults_multiplot, echo = FALSE, fig.height=15, fig.width=16, fig.align = 'center'}
multiplot(CRP_mean_p, GP_mean_p, HbA_mean_p, CRP_median_p, GP_median_p, HbA_median_p, cols = 2)
```

```{r props_boot, echo = FALSE}
ferrLBs <- c(5, 10, 15, 20, 25, 30, 35, 40, 45, 50)
if (!file.exists(paste0("~/CRP_enrichment/data/ferritin_threshold_boot", boot_n, ".rds"))){ # run bootstrap only if needed
    start <- Sys.time()
    # CRP
    CRP_diffs <- c()
    CRP_lower <- c()
    CRP_upper <- c()
    for (i in 1:length(ferrLBs)) {
        boot_obj <- boot(h2000_filtered, statistic = get_ratio_boot, R = boot_n, var1 = FERRITIINI, var2 = CRP, var1_trld = ferrLBs[i], var2_trld = 3)
        ci_obj <- boot.ci(boot_obj, type = "norm")
        CRP_diffs[i] <- boot_obj$t0
        CRP_lower[i] <- ci_obj$normal[2]
        CRP_upper[i] <- ci_obj$normal[3]
    }
    # GlycA
    GP_diffs <- c()
    GP_lower <- c()
    GP_upper <- c()
    GP_median <- median(h2000_filtered$GP, na.rm = T)
    for (i in 1:length(ferrLBs)) {
        boot_obj <- boot(h2000_filtered, statistic = get_ratio_boot, R = boot_n, var1 = FERRITIINI, var2 = GP, var1_trld = ferrLBs[i], var2_trld = GP_median)
        ci_obj <- boot.ci(boot_obj, type = "norm")
        GP_diffs[i] <- boot_obj$t0
        GP_lower[i] <- ci_obj$normal[2]
        GP_upper[i] <- ci_obj$normal[3]
    }
    # HbA_1C
    hba_diffs <- c()
    hba_lower <- c()
    hba_upper <- c()
    h2000_m <- h2000_filtered %>%
        mutate(hba = B_GHb_A1C * 10.93 - 23.50)
    for (i in 1:length(ferrLBs)) {
        boot_obj <- boot(h2000_m, statistic = get_ratio_boot, R = boot_n, var1 = FERRITIINI, var2 = hba, var1_trld = ferrLBs[i], var2_trld = 42)
        ci_obj <- boot.ci(boot_obj, type = "norm")
        hba_diffs[i] <- boot_obj$t0
        hba_lower[i] <- ci_obj$normal[2]
        hba_upper[i] <- ci_obj$normal[3]
    }
    
    boot_diff_df <- data.frame(LB = rep(ferrLBs, 3), diffs = c(CRP_diffs, GP_diffs, hba_diffs), 
                               lower = c(CRP_lower, GP_lower, hba_lower), upper = c(CRP_upper, GP_upper, hba_upper),
                                group = c(rep("CRP", 10), rep("GlycA", 10), rep("HbA1C", 10)))
    
    # save to file so we don't have to do this every time
    saveRDS(boot_diff_df, paste0("~/CRP_enrichment/data/ferritin_threshold_boot", boot_n, ".rds"))
    
    end <- Sys.time()
    print(end - start)
} else {
    boot_diff_df <- readRDS(paste0("~/CRP_enrichment/data/ferritin_threshold_boot", boot_n, ".rds"))
}
```

```{r prop_plot, echo = FALSE, fig.height=5, fig.width=12, fig.align = 'center'}
ggplot(data = boot_diff_df, aes(x = LB, y = diffs, color = group)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = group), alpha = .2, color = NA) +
    geom_line() +
    geom_point(shape = 4) +
    theme_minimal() +
    labs(title = "Growth of number of individuals over marker threshold per ferritin filter level",
         subtitle = paste("Cohort: Health2000 | Donation restrictions for age, Hb, and weight applied | 95% CI from", boot_n, "bootstrap samples"),
         y = "Difference (pp)",
         x = "Ferritin filter (ug/l)",
         color = "Marker") + guides(fill = "none")
```

## Self reported health

```{r marker_x_health_bootmean, echo = FALSE, warning = FALSE}
ferrLBs <- c(5, 10, 15, 20, 25, 30, 35, 40, 45, 50)
CRPLBs <- c(0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5)
GPLBs <- as.numeric(quantile(h2000_filtered$GP, 0.1 * (0.9:9.9), na.rm = T))
HbA1CLBs <- c(18, 24, 30, 36, 42, 48, 54, 60, 66, 72)
if (!file.exists(paste0("~/CRP_enrichment/data/ferritin_x_SRhealth_boot", boot_n, ".rds"))){ # run bootstrap only if needed
    start <- Sys.time()
    # Ferritin
    fer_diffs <- c()
    fer_lower <- c()
    fer_upper <- c()
    for (i in 1:length(ferrLBs)) {
        boot_obj <- boot(h2000_filtered, statistic = get_mean_boot, R = boot_n, var1 = FERRITIINI, var2 = BA01, var1_trld = ferrLBs[i])
        ci_obj <- boot.ci(boot_obj, type = "norm")
        fer_diffs[i] <- boot_obj$t0
        fer_lower[i] <- ci_obj$normal[2]
        fer_upper[i] <- ci_obj$normal[3]
    }

    # CRP
    CRP_diffs <- c()
    CRP_lower <- c()
    CRP_upper <- c()
    for (i in 1:length(ferrLBs)) {
        boot_obj <- boot(h2000_filtered, statistic = get_mean_boot, R = boot_n, var1 = CRP, var2 = BA01, var1_trld = CRPLBs[i])
        ci_obj <- boot.ci(boot_obj, type = "norm")
        CRP_diffs[i] <- boot_obj$t0
        CRP_lower[i] <- ci_obj$normal[2]
        CRP_upper[i] <- ci_obj$normal[3]
    }

    # GlycA
    GP_diffs <- c()
    GP_lower <- c()
    GP_upper <- c()
    GP_median <- median(h2000_filtered$GP, na.rm = T)
    for (i in 1:length(ferrLBs)) {
        boot_obj <- boot(h2000_filtered, statistic = get_mean_boot, R = boot_n, var1 = GP, var2 = BA01, var1_trld = GPLBs[i])
        ci_obj <- boot.ci(boot_obj, type = "norm")
        GP_diffs[i] <- boot_obj$t0
        GP_lower[i] <- ci_obj$normal[2]
        GP_upper[i] <- ci_obj$normal[3]
    }
    
    # HbA_1C
    hba_diffs <- c()
    hba_lower <- c()
    hba_upper <- c()
    h2000_m <- h2000_filtered %>%
        mutate(hba = B_GHb_A1C * 10.93 - 23.50)
    for (i in 1:length(ferrLBs)) {
        boot_obj <- boot(h2000_m, statistic = get_mean_boot, R = boot_n, var1 = hba, var2 = BA01, var1_trld = HbA1CLBs[i])
        ci_obj <- boot.ci(boot_obj, type = "norm")
        hba_diffs[i] <- boot_obj$t0
        hba_lower[i] <- ci_obj$normal[2]
        hba_upper[i] <- ci_obj$normal[3]
    }
    
    boot_mean_df <- data.frame(LBs = c(ferrLBs, CRPLBs, GPLBs, HbA1CLBs),
                               diffs = c(fer_diffs, CRP_diffs, GP_diffs, hba_diffs), 
                               lower = c(fer_lower, CRP_lower, GP_lower, hba_lower), 
                               upper = c(fer_upper, CRP_upper, GP_upper, hba_upper),
                               group = c(rep("Ferritin", 10), rep("CRP", 10), rep("GlycA", 10), rep("HbA1C", 10)))
    
    # save to file so we don't have to do this every time
    saveRDS(boot_mean_df, paste0("~/CRP_enrichment/data/ferritin_x_SRhealth_boot", boot_n, ".rds"))
    
    end <- Sys.time()
    print(end - start)
} else {
    boot_mean_df <- readRDS(paste0("~/CRP_enrichment/data/ferritin_x_SRhealth_boot", boot_n, ".rds"))
}
```

This plot shows how the mean of self reported health reacts to increasing marker values.

1. Ferritin: [5, 50] in increments of 5. (So that we have the cutoff of 30 in the "middle".)
2. CRP: [0.5, 5] in increments of 0.5. (So that we have cutoff of 3 in the "middle".)
3. GlycA: 10 quantiles. (So that we have the population mean in the "middle".)
4. HbA$_{1C}$: [18, 72] in increments of 6. (So that we have the cutoff of 42 in the "middle".)

```{r SRH_plot, echo = FALSE, warning = FALSE, fig.height = 7, fig.width = 11, fig.align = 'center'}
ferp <- ggplot(data = boot_mean_df[1:10, ], aes(x = LBs, y = diffs)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = .2) +
    geom_line() +
    geom_point(shape = 4) +
    theme_minimal() +
    labs(title = "Self reported health (Likert) mean by ferritin level",
         subtitle = paste("Cohort: Health2000 | Donation restrictions for age, Hb, and weight applied | 95% CI from", boot_n, "bootstrap samples"),
         y = "Mean of self reported health",
         x = "Ferritin (ug/l)",
         color = "Marker") + guides(fill = "none")

crpp <- ggplot(data = boot_mean_df[11:20, ], aes(x = LBs, y = diffs)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#F8766D", alpha = .2) +
    geom_line(color = "#F8766D") +
    geom_point(shape = 4) +
    theme_minimal() +
    labs(title = "by CRP level",
         y = "Mean of self reported health",
         x = "CRP (mg/l)",
         color = "Marker") + guides(fill = "none")

gpp <- ggplot(data = boot_mean_df[21:30, ], aes(x = LBs, y = diffs)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#00BA38", alpha = .2) +
    geom_line(color = "#00BA38") +
    geom_point(shape = 4) +
    theme_minimal() +
    labs(title = "by GlycA level",
         x = "GlycA (mg/l)",
         y = "",
         color = "Marker") + guides(fill = "none")

hbap <- ggplot(data = boot_mean_df[31:40, ], aes(x = LBs, y = diffs)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#619CFF", alpha = .2) +
    geom_line(color = "#619CFF") +
    geom_point(shape = 4) +
    theme_minimal() +
    labs(title = "by HbA1C level",
         x = "HbA1C (mmol/mol)",
         y = "",
         color = "Marker") + guides(fill = "none")

multiplot(ferp, crpp, gpp, hbap, cols = 2)
```

The mean of self reported health clearly increases (so: SR health worsens) with ferritin. The others offer a couple of dipping points (very interesting) as we go further up with the markers.

Let's assume that people who report their health as "bad" (5) don't come to donate. Does it affect our ratio analysis?

```{r h2000_healthier, echo = FALSE}
h2000_healthier <- h2000_filtered %>%
    filter(BA01 < 5)
```

```{r, echo = FALSE}
ferrLBs <- c(5, 10, 15, 20, 25, 30, 35, 40, 45, 50)
if (!file.exists(paste0("~/CRP_enrichment/data/healthy_ferritin_threshold_boot", boot_n, ".rds"))){ # run bootstrap only if needed
    start <- Sys.time()
    # CRP
    CRP_diffs <- c()
    CRP_lower <- c()
    CRP_upper <- c()
    for (i in 1:length(ferrLBs)) {
        boot_obj <- boot(h2000_healthier, statistic = get_ratio_boot, R = boot_n, var1 = FERRITIINI, var2 = CRP, var1_trld = ferrLBs[i], var2_trld = 3)
        ci_obj <- boot.ci(boot_obj, type = "norm")
        CRP_diffs[i] <- boot_obj$t0
        CRP_lower[i] <- ci_obj$normal[2]
        CRP_upper[i] <- ci_obj$normal[3]
    }
    # GlycA
    GP_diffs <- c()
    GP_lower <- c()
    GP_upper <- c()
    GP_median <- median(h2000_healthier$GP, na.rm = T)
    for (i in 1:length(ferrLBs)) {
        boot_obj <- boot(h2000_filtered, statistic = get_ratio_boot, R = boot_n, var1 = FERRITIINI, var2 = GP, var1_trld = ferrLBs[i], var2_trld = GP_median)
        ci_obj <- boot.ci(boot_obj, type = "norm")
        GP_diffs[i] <- boot_obj$t0
        GP_lower[i] <- ci_obj$normal[2]
        GP_upper[i] <- ci_obj$normal[3]
    }
    # HbA_1C
    hba_diffs <- c()
    hba_lower <- c()
    hba_upper <- c()
    h2000_m <- h2000_healthier %>%
        mutate(hba = B_GHb_A1C * 10.93 - 23.50)
    for (i in 1:length(ferrLBs)) {
        boot_obj <- boot(h2000_m, statistic = get_ratio_boot, R = boot_n, var1 = FERRITIINI, var2 = hba, var1_trld = ferrLBs[i], var2_trld = 42)
        ci_obj <- boot.ci(boot_obj, type = "norm")
        hba_diffs[i] <- boot_obj$t0
        hba_lower[i] <- ci_obj$normal[2]
        hba_upper[i] <- ci_obj$normal[3]
    }
    
    boot_diff_df <- data.frame(LB = rep(ferrLBs, 3), diffs = c(CRP_diffs, GP_diffs, hba_diffs), 
                               lower = c(CRP_lower, GP_lower, hba_lower), upper = c(CRP_upper, GP_upper, hba_upper),
                                group = c(rep("CRP", 10), rep("GlycA", 10), rep("HbA1C", 10)))
    
    # save to file so we don't have to do this every time
    saveRDS(boot_diff_df, paste0("~/CRP_enrichment/data/healthy_ferritin_threshold_boot", boot_n, ".rds"))
    
    end <- Sys.time()
    print(end - start)
} else {
    boot_diff_df <- readRDS(paste0("~/CRP_enrichment/data/healthy_ferritin_threshold_boot", boot_n, ".rds"))
}
```

```{r prop_plot_healthy, echo = FALSE, fig.height=5, fig.width=12, fig.align = 'center'}
ggplot(data = boot_diff_df, aes(x = LB, y = diffs, color = group)) + 
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = group), alpha = .2, color = NA) +
    geom_line() +
    geom_point(shape = 4) +
    theme_minimal() +
    labs(title = "Growth of number of individuals over marker threshold per ferritin filter level",
         subtitle = paste("Cohort: Health2000 | Donation restrictions for age, Hb, weight and SRH < 5 applied | 95% CI from", boot_n, "bootstrap samples"),
         y = "Difference (pp)",
         x = "Ferritin filter (ug/l)",
         color = "Marker") + guides(fill = "none")
```

It does seem to lower the level of GlycA by ~0.7 pp, CRP by ~0.2 pp, and HbA$_{1C}$ by 0.1 pp.
